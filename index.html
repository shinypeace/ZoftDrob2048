<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soft Drop 2048</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --bg-color: #FAF8EF;
            --text-color: #776e65;
            --header-bg: #bbada0;
            --score-bg: #cdc1b4;
            --score-text: #eee4da;
            --canvas-bg: #CDC1B4;
            --modal-bg: rgba(250, 248, 239, 0.95);
            --modal-shadow: rgba(0,0,0,0.15);
            --btn-bg: #faf8ef;
            --btn-text: #776e65;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --card-locked: #f3f4f6;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #e5e7eb;
            --header-bg: #374151;
            --score-bg: #4b5563;
            --score-text: #e5e7eb;
            --canvas-bg: #1f2937;
            --modal-bg: rgba(17, 24, 39, 0.95);
            --modal-shadow: rgba(0,0,0,0.5);
            --btn-bg: #374151;
            --btn-text: #e5e7eb;
            --card-bg: #1f2937;
            --card-border: #374151;
            --card-locked: #111827;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
            -webkit-user-select: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ UI */
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        #game-wrapper {
            position: relative;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            filter: drop-shadow(0 10px 20px var(--modal-shadow));
        }

        #game-header {
            background: var(--header-bg);
            border-radius: 12px 12px 0 0;
            height: 70px;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            transition: background 0.3s;
        }

        .score-box {
            background: var(--score-bg);
            padding: 5px 15px;
            border-radius: 6px;
            color: var(--score-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            transition: background 0.3s;
        }

        canvas {
            display: block;
            border-radius: 0 0 12px 12px;
            background: var(--canvas-bg);
            transition: background 0.3s;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--btn-text);
            background: var(--btn-bg);
            font-size: 1.2rem;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: visible;
        }
        .control-btn:active { transform: scale(0.95); }
        
        .delete-active {
            background: #ff6b6b !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        
        .ad-badge {
            position: absolute;
            top: -6px; right: -6px;
            background-color: #3b82f6;
            color: white; font-size: 9px; font-weight: 900;
            padding: 2px 4px; border-radius: 4px;
            border: 2px solid var(--bg-color);
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .menu-modal {
            position: absolute; inset: 0; z-index: 50;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        .menu-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª --- */
        .tutorial-container {
            position: relative; width: 120px; height: 160px;
            background: rgba(0,0,0,0.05); border-radius: 12px;
            margin: 0 auto 10px; overflow: hidden;
        }
        
        .t-ball {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; color: #776e65;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        .t-ball.val-2 { background: #eee4da; }
        .t-ball.val-4 { background: #ede0c8; color: #776e65; }

        .t-hand {
            position: absolute; font-size: 24px; top: 10px; left: 50%;
            transform: translateX(-50%);
            animation: handMove 3s infinite;
            z-index: 10;
        }

        .t-drop {
            left: 50%; top: 40px; margin-left: -15px; opacity: 0;
            animation: ballDrop 3s infinite;
        }

        .t-static {
            left: 50%; bottom: 10px; margin-left: -15px;
            animation: ballMergeBottom 3s infinite;
        }

        @keyframes handMove {
            0%, 10% { transform: translateX(-50%) scale(1); }
            20% { transform: translateX(-50%) scale(0.9); } /* Press */
            30% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1); }
        }

        @keyframes ballDrop {
            0%, 20% { top: 40px; opacity: 0; }
            25% { opacity: 1; }
            45% { top: 110px; opacity: 1; } /* Hit */
            50% { opacity: 0; } /* Disappear on merge */
            100% { opacity: 0; }
        }

        @keyframes ballMergeBottom {
            0%, 45% { transform: scale(1); background: #eee4da; content: "2"; }
            50% { transform: scale(1.2); background: #ede0c8; } /* Pop */
            60% { transform: scale(1); background: #ede0c8; } /* 4 */
            85% { opacity: 1; }
            90% { opacity: 0; } /* Reset loop */
            100% { opacity: 0; }
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } }
    </style>
</head>
<body>

    <!-- –û–±–µ—Ä—Ç–∫–∞ –∏–≥—Ä—ã -->
    <div id="game-wrapper" class="hidden">
        
        <!-- –®–∞–ø–∫–∞ -->
        <div id="game-header">
            <div class="score-box">
                <span class="text-[10px] font-bold uppercase tracking-wider opacity-70">–°—á–µ—Ç</span>
                <span id="score-display" class="text-xl font-bold leading-tight">0</span>
            </div>

            <div class="flex gap-3">
                <!-- –õ–∞—Å—Ç–∏–∫ -->
                <button id="btn-delete" onclick="game.tryActivateDelete()" class="control-btn" title="–£–¥–∞–ª–∏—Ç—å —à–∞—Ä">
                    <div class="ad-badge">AD</div>
                    <i class="fas fa-eraser"></i>
                </button>

                <!-- –ü–∞—É–∑–∞ -->
                <button onclick="game.togglePause()" class="control-btn" title="–ü–∞—É–∑–∞">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
        </div>

        <canvas id="world"></canvas>
        
        <!-- –õ–∏–Ω–∏—è –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
        <div id="danger-line" class="absolute w-full border-b-2 border-dashed border-red-400 opacity-0 transition-opacity duration-300 pointer-events-none z-20" style="top: 200px;">
            <span class="absolute right-2 -top-6 text-[10px] text-white font-bold bg-red-400 px-2 py-0.5 rounded-full shadow-sm">–û–ü–ê–°–ù–û–°–¢–¨</span>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ü–∞—É–∑—ã -->
        <div id="pause-screen" class="absolute inset-0 z-40 hidden flex flex-col items-center justify-center rounded-xl bounce-in" style="background: var(--modal-bg); backdrop-filter: blur(5px);">
            <h2 class="text-3xl font-black mb-6" style="color: var(--text-color);">–ü–∞—É–∑–∞</h2>
            <div class="w-48 space-y-3">
                <button onclick="game.togglePause()" class="w-full bg-[#edc22e] text-white py-3 rounded-lg font-bold shadow-md menu-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button onclick="game.quitToMenu()" class="w-full bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow-md menu-btn">–ú–µ–Ω—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω Game Over -->
        <div id="gameover-screen" class="absolute inset-0 z-40 hidden flex flex-col items-center justify-center rounded-xl bounce-in" style="background: var(--modal-bg); backdrop-filter: blur(5px);">
            <h2 class="text-4xl font-black mb-2" style="color: var(--text-color);">–§–∏–Ω–∏—Ç–∞!</h2>
            <p class="mb-6 text-sm font-semibold opacity-70" style="color: var(--text-color);">–ú–µ—Å—Ç–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç</p>
            
            <div class="rounded-lg px-8 py-4 mb-8 text-center shadow-inner" style="background: var(--score-bg); color: var(--score-text);">
                <div class="text-xs uppercase font-bold opacity-70">–í–∞—à —Å—á–µ—Ç</div>
                <div id="final-score" class="text-4xl font-black">0</div>
            </div>

            <div class="w-56 space-y-3">
                <button onclick="game.restart()" class="w-full bg-[#edc22e] text-white py-3 rounded-lg font-bold shadow-lg menu-btn hover:bg-[#e5ba2a]">
                    <i class="fas fa-redo mr-2"></i> –ó–∞–Ω–æ–≤–æ
                </button>
                <button onclick="game.quitToMenu()" class="w-full bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow-md menu-btn">
                    <i class="fas fa-home mr-2"></i> –ú–µ–Ω—é
                </button>
            </div>
        </div>
    </div>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="main-menu" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 transition-colors duration-300" style="background: var(--bg-color);">
        <div class="absolute top-4 right-4">
             <button onclick="ui.showSettings()" class="control-btn shadow-none bg-transparent hover:bg-black/5">
                <i class="fas fa-cog fa-lg"></i>
            </button>
        </div>

        <div class="text-center mb-10 slide-up">
            <div class="inline-block bg-[#edc22e] text-white text-5xl font-black p-4 rounded-xl shadow-lg mb-2">2048</div>
            <div class="text-3xl font-bold tracking-widest uppercase" style="color: var(--text-color);">Soft Drop</div>
        </div>
        
        <div class="w-full max-w-sm space-y-4 slide-up" style="animation-delay: 0.1s;">
            <div class="text-sm font-bold uppercase tracking-wide mb-2 ml-1 opacity-70" style="color: var(--text-color);">–†–µ–∂–∏–º –∏–≥—Ä—ã</div>
            <div id="level-select" class="grid grid-cols-1 gap-3">
                <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="ui.showRules()" class="bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow hover:bg-[#7f6a56] menu-btn text-sm">
                    –ö–∞–∫ –∏–≥—Ä–∞—Ç—å
                </button>
                <button onclick="ui.showStats()" class="bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow hover:bg-[#7f6a56] menu-btn text-sm">
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ù–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-6" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" style="color: var(--text-color);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="ui.hideModal('settings-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="space-y-4">
                <!-- –¢–µ–º–∞ -->
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--card-locked);">
                    <span class="font-bold" style="color: var(--text-color);">–¢–µ–º–∞</span>
                    <button id="theme-btn" onclick="ui.toggleTheme()" class="px-4 py-2 rounded-lg font-bold text-white transition-colors bg-[#8f7a66]">
                        –°–≤–µ—Ç–ª–∞—è
                    </button>
                </div>

                <!-- –ó–≤—É–∫ -->
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--card-locked);">
                    <span class="font-bold" style="color: var(--text-color);">–ó–≤—É–∫–∏</span>
                    <button id="sound-btn" onclick="ui.toggleSound()" class="px-4 py-2 rounded-lg font-bold text-white transition-colors bg-[#22c55e]">
                        –í–ö–õ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ü—Ä–∞–≤–∏–ª (–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) -->
    <div id="rules-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-5" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--card-border);">
                <h3 class="text-lg font-bold" style="color: var(--text-color);">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h3>
                <button onclick="ui.hideModal('rules-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- –ê–Ω–∏–º–∞—Ü–∏—è -->
            <div class="tutorial-container">
                <div class="t-hand">üëÜ</div>
                <div class="t-ball t-drop val-2">2</div>
                <div class="t-ball t-static val-2">2</div>
                <!-- –§–∏–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å–º–µ–Ω—ã —Ü–∏—Ñ—Ä—ã –≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ CSS content, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ç—É—Ç —Å—Ç–∞—Ç–∏–∫–∞ -->
            </div>

            <div class="text-sm space-y-4" style="color: var(--text-color);">
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#bbada0] flex items-center justify-center text-white font-bold shrink-0 text-xs">1</div>
                    <p>–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —à–∞—Ä.</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#f65e3b] flex items-center justify-center text-white font-bold shrink-0 text-xs">2</div>
                    <p>–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —á–∏—Å–ª–∞ —Å–ª–∏–≤–∞—é—Ç—Å—è (2+2=4).</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#edc22e] flex items-center justify-center text-white font-bold shrink-0 text-xs">
                        <i class="fas fa-eraser"></i>
                    </div>
                    <p>–õ–∞—Å—Ç–∏–∫ —É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω–∏–π —à–∞—Ä.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="stats-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-5" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--card-border);">
                <h3 class="text-lg font-bold" style="color: var(--text-color);">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <button onclick="ui.hideModal('stats-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="text-center mb-6">
                <div class="text-xs uppercase opacity-60 mb-1" style="color: var(--text-color);">–†–µ–∫–æ—Ä–¥ –æ—á–∫–æ–≤</div>
                <div id="stat-high-score" class="text-4xl font-black text-[#edc22e] tracking-tight">0</div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="p-3 rounded-xl text-center" style="background: var(--card-locked);">
                    <div class="text-[10px] uppercase opacity-60" style="color: var(--text-color);">–í—Å–µ–≥–æ –∏–≥—Ä</div>
                    <div id="stat-total-games" class="text-lg font-bold" style="color: var(--text-color);">0</div>
                </div>
                <div class="p-3 rounded-xl text-center" style="background: var(--card-locked);">
                    <div class="text-[10px] uppercase opacity-60" style="color: var(--text-color);">–ú–∞–∫—Å. –®–∞—Ä</div>
                    <div id="stat-max-tile" class="text-lg font-bold text-[#f67c5f]">0</div>
                </div>
            </div>
            <div class="mt-3 p-3 rounded-xl text-center" style="background: var(--card-locked);">
                <div class="text-[10px] uppercase opacity-60" style="color: var(--text-color);">–û—Ç–∫—Ä—ã—Ç–æ —É—Ä–æ–≤–Ω–µ–π</div>
                <div id="stat-unlocked-levels" class="text-lg font-bold text-[#8f7a66]">1/3</div>
            </div>
        </div>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const CONFIG = {
            colors: {
                2: "#eee4da", 4: "#ede0c8", 8: "#f2b179", 16: "#f59563",
                32: "#f67c5f", 64: "#f65e3b", 128: "#edcf72", 256: "#edcc61",
                512: "#edc850", 1024: "#edc53f", 2048: "#edc22e", 4096: "#3c3a32"
            },
            textColors: {
                2: "#776e65", 4: "#776e65", 8: "#f9f6f2"
            },
            levels: [
                { id: 'classic', name: '–ö–ª–∞—Å—Å–∏–∫–∞', scoreReq: 0, width: 340, desc: '–°—Ç–∞–Ω–¥–∞—Ä—Ç' },
                { id: 'narrow', name: '–ö–æ–ª–±–∞', scoreReq: 2000, width: 280, desc: '–°–ª–æ–∂–Ω–æ' },
                { id: 'wide', name: '–í–∞–Ω–Ω–∞', scoreReq: 5000, width: 390, desc: '–•–∞–æ—Å' }
            ]
        };

        // --- VK –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ---
        let vkUserId = null;
        
        async function initVK() {
            try {
                if(window.vkBridge) {
                    await window.vkBridge.send('VKWebAppInit');
                    try {
                        const user = await window.vkBridge.send('VKWebAppGetUserInfo');
                        vkUserId = user.id;
                    } catch (e) { console.warn("VK User Error", e); }

                    // –ë–∞–Ω–Ω–µ—Ä
                    window.vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(()=>{});
                }
            } catch (e) { console.error("VK Init Error", e); }
        }

        async function showRewardedAd() {
            if (!window.vkBridge) return true;
            try {
                const data = await window.vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' });
                return data.result;
            } catch (error) { return false; }
        }

        function showInterstitialAd() {
            if (window.vkBridge) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º
                window.vkBridge.send('VKWebAppShowInterstitialAd').catch(e => console.log("Ads Error:", e));
            }
        }

        // --- AUDIO ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = true;
            }
            playPop(value) {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const freq = 200 + (Math.log2(value) * 60);
                osc.frequency.setValueAtTime(freq, t);
                osc.frequency.exponentialRampToValueAtTime(freq + 150, t + 0.1);
                gain.gain.setValueAtTime(0.15, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(t + 0.2);
            }
            playDelete() {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.3);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(t + 0.3);
            }
            playDrop() {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(80, t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(t + 0.05);
            }
            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
            toggle(state) { this.enabled = state; }
        }

        // --- DATA ---
        class DataManager {
            constructor() {
                this.data = {
                    highScore: 0, 
                    totalGames: 0, 
                    maxTile: 2, 
                    unlockedLevels: ['classic'],
                    theme: 'light',
                    sound: true
                };
            }

            async load() {
                // –ü—ã—Ç–∞–µ–º—Å—è –≥—Ä—É–∑–∏—Ç—å –∏–∑ LocalStorage —Å–Ω–∞—á–∞–ª–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                const local = localStorage.getItem('softdrop_save');
                if (local) this.data = { ...this.data, ...JSON.parse(local) };

                // –ï—Å–ª–∏ –µ—Å—Ç—å –í–ö, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç—Ç—É–¥–∞
                if (vkUserId && window.vkBridge) {
                    try {
                        const response = await window.vkBridge.send('VKWebAppStorageGet', { keys: [`save_${vkUserId}`] });
                        if (response.keys[0]?.value) {
                            this.data = { ...this.data, ...JSON.parse(response.keys[0].value) };
                        }
                    } catch (e) { console.warn("VK Load Error", e); }
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                this.applySettings();
            }

            async save() {
                const val = JSON.stringify(this.data);
                localStorage.setItem('softdrop_save', val);
                
                if (vkUserId && window.vkBridge) {
                    window.vkBridge.send('VKWebAppStorageSet', { key: `save_${vkUserId}`, value: val }).catch(()=>{});
                }
            }

            updateScore(score, maxTile) {
                let changed = false;
                if (score > this.data.highScore) { this.data.highScore = score; changed = true; }
                if (maxTile > this.data.maxTile) { this.data.maxTile = maxTile; changed = true; }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω–µ–π
                CONFIG.levels.forEach(lvl => {
                    if (this.data.highScore >= lvl.scoreReq && !this.data.unlockedLevels.includes(lvl.id)) {
                        this.data.unlockedLevels.push(lvl.id);
                        changed = true;
                    }
                });
                
                if (changed) {
                    this.data.unlockedLevels.sort((a, b) => 
                        CONFIG.levels.find(l=>l.id===a).scoreReq - CONFIG.levels.find(l=>l.id===b).scoreReq
                    );
                    this.save();
                }
            }

            gameFinished() { this.data.totalGames++; this.save(); }

            toggleTheme() {
                this.data.theme = this.data.theme === 'light' ? 'dark' : 'light';
                this.applySettings();
                this.save();
                return this.data.theme;
            }

            toggleSound() {
                this.data.sound = !this.data.sound;
                this.applySettings();
                this.save();
                return this.data.sound;
            }

            applySettings() {
                document.documentElement.setAttribute('data-theme', this.data.theme);
                game.sound.toggle(this.data.sound);
            }
        }

        // --- GAME ENGINE ---
        class Game {
            constructor() {
                this.engine = Matter.Engine.create({ enableSleeping: true });
                this.runner = Matter.Runner.create();
                this.renderCanvas = document.getElementById('world');
                this.ctx = this.renderCanvas.getContext('2d');
                
                this.width = 340;
                this.height = window.innerHeight * 0.75;
                
                this.score = 0;
                this.isPlaying = false;
                this.isPaused = false;
                this.deleteMode = false;
                
                this.nextValue = 2;
                this.currentBall = null;
                
                this.sound = new SoundManager();
                this.data = new DataManager();
                
                window.addEventListener('resize', () => { if(this.isPlaying) this.resize(); });
                this.setupInput();
                this.setupPhysicsEvents();
            }

            resize() {
                const maxHeight = Math.min(window.innerHeight * 0.75, 800);
                this.height = maxHeight;
                this.renderCanvas.width = this.width;
                this.renderCanvas.height = this.height;
                document.getElementById('game-wrapper').style.width = `${this.width}px`;
                
                if (this.ground) Matter.Body.setPosition(this.ground, { x: this.width/2, y: this.height + 50 });
                const dangerLine = document.getElementById('danger-line');
                if (dangerLine) dangerLine.style.top = `${this.height * 0.25}px`; 
            }

            start(levelId) {
                const level = CONFIG.levels.find(l => l.id === levelId);
                this.width = level.width;
                this.resize();

                Matter.World.clear(this.engine.world);
                Matter.Engine.clear(this.engine);
                
                this.score = 0;
                this.isPlaying = true;
                this.isPaused = false;
                this.deleteMode = false;
                this.updateUI();
                
                this.leftWall = Matter.Bodies.rectangle(-50, this.height/2, 100, this.height * 3, { isStatic: true, friction: 0.1, restitution: 0.2 });
                this.rightWall = Matter.Bodies.rectangle(this.width + 50, this.height/2, 100, this.height * 3, { isStatic: true, friction: 0.1, restitution: 0.2 });
                this.ground = Matter.Bodies.rectangle(this.width/2, this.height + 50, this.width + 200, 100, { isStatic: true, friction: 0.1, restitution: 0.2 });
                
                Matter.World.add(this.engine.world, [this.ground, this.leftWall, this.rightWall]);

                Matter.Runner.run(this.runner, this.engine);
                this.sound.resume();
                this.spawnNextPreview();
                this.loop();
                ui.showScreen('game');
            }

            spawnNextPreview() {
                const r = Math.random();
                if (r < 0.6) this.nextValue = 2;
                else if (r < 0.85) this.nextValue = 4;
                else if (r < 0.95) this.nextValue = 8;
                else if (r < 0.99) this.nextValue = 16;
                else this.nextValue = 32;

                this.currentBall = { x: this.width / 2, y: 60, value: this.nextValue, radius: this.getRadius(this.nextValue) };
            }

            dropBall() {
                if (!this.currentBall || this.isPaused || !this.isPlaying || this.deleteMode) return;
                const body = Matter.Bodies.circle(this.currentBall.x, this.currentBall.y, this.currentBall.radius, {
                    restitution: 0.3, friction: 0.5, label: `ball-${this.currentBall.value}`
                });
                body.gameValue = this.currentBall.value;
                Matter.World.add(this.engine.world, body);
                this.sound.playDrop();
                this.currentBall = null;
                setTimeout(() => { if (this.isPlaying) this.spawnNextPreview(); }, 400);
            }

            getRadius(value) { return 22 + (Math.log2(value) * 2.5); }

            setupPhysicsEvents() {
                Matter.Events.on(this.engine, 'collisionStart', (event) => {
                    event.pairs.forEach((pair) => {
                        const A = pair.bodyA; const B = pair.bodyB;
                        if (A.isStatic || B.isStatic) return;
                        if (A.gameValue === B.gameValue && !A.toRemove && !B.toRemove) {
                            A.toRemove = true; B.toRemove = true;
                            this.mergeBodies(A, B);
                        }
                    });
                });
                setInterval(() => { if(this.isPlaying && !this.isPaused) this.checkGameOver(); }, 1000);
            }

            mergeBodies(A, B) {
                const newValue = A.gameValue * 2;
                const midX = (A.position.x + B.position.x) / 2;
                const midY = (A.position.y + B.position.y) / 2;
                Matter.World.remove(this.engine.world, [A, B]);
                const newRadius = this.getRadius(newValue);
                const newBody = Matter.Bodies.circle(midX, midY, newRadius, { restitution: 0.3, friction: 0.5 });
                newBody.gameValue = newValue;
                Matter.World.add(this.engine.world, newBody);
                this.score += newValue;
                this.sound.playPop(newValue);
                this.updateUI();
            }

            checkGameOver() {
                const dangerY = this.height * 0.25; 
                let dangerCount = 0;
                const bodies = Matter.Composite.allBodies(this.engine.world);
                bodies.forEach(b => { if (!b.isStatic && b.position.y < dangerY && Math.abs(b.velocity.y) < 0.1) dangerCount++; });
                
                const line = document.getElementById('danger-line');
                if(line) line.style.opacity = dangerCount > 0 ? '1' : '0';
                
                const topTouch = bodies.some(b => !b.isStatic && b.position.y - b.circleRadius <= 0);

                if (dangerCount > 1 || topTouch) {
                    setTimeout(() => {
                        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                       if(this.isPlaying && (document.getElementById('danger-line')?.style.opacity === '1' || topTouch)) {
                           this.gameOver();
                       }
                    }, 1500);
                }
            }

            setupInput() {
                const getPos = (e) => {
                    const rect = this.renderCanvas.getBoundingClientRect();
                    let t = (e.touches && e.touches.length > 0) ? e.touches[0] : (e.changedTouches && e.changedTouches.length > 0 ? e.changedTouches[0] : e);
                    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
                };
                const handleMove = (pos) => {
                    if (this.deleteMode || !this.currentBall || this.isPaused) return;
                    const r = this.currentBall.radius;
                    this.currentBall.x = Math.max(r, Math.min(this.width - r, pos.x));
                };
                const handleClick = (e) => {
                    e.preventDefault();
                    if (this.deleteMode) this.tryDeleteAt(getPos(e)); else this.dropBall();
                };
                this.renderCanvas.addEventListener('mousemove', e => handleMove(getPos(e)));
                this.renderCanvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(getPos(e)); }, { passive: false });
                this.renderCanvas.addEventListener('mousedown', handleClick);
                this.renderCanvas.addEventListener('touchend', handleClick);
            }

            async tryActivateDelete() {
                if (this.deleteMode) { this.toggleDeleteMode(); return; }
                const success = await showRewardedAd();
                if (success) this.toggleDeleteMode();
            }

            toggleDeleteMode() {
                this.deleteMode = !this.deleteMode;
                const btn = document.getElementById('btn-delete');
                const canvas = document.getElementById('world');
                if (this.deleteMode) { btn.classList.add('delete-active'); canvas.classList.add('cursor-delete'); }
                else { btn.classList.remove('delete-active'); canvas.classList.remove('cursor-delete'); }
            }

            tryDeleteAt(pos) {
                const bodies = Matter.Composite.allBodies(this.engine.world);
                const clickedBody = bodies.find(b => {
                    if (b.isStatic) return false;
                    const dx = b.position.x - pos.x;
                    const dy = b.position.y - pos.y;
                    return (dx*dx + dy*dy) < (b.circleRadius * b.circleRadius);
                });
                if (clickedBody) {
                    Matter.World.remove(this.engine.world, clickedBody);
                    this.sound.playDelete();
                    this.toggleDeleteMode();
                }
            }

            loop() {
                if (!this.isPlaying) return;
                requestAnimationFrame(() => this.loop());
                
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ü–≤–µ—Ç –∫–∞–Ω–≤–∞—Å–∞
                const canvasColor = getComputedStyle(document.body).getPropertyValue('--canvas-bg').trim();
                this.ctx.fillStyle = canvasColor || "#CDC1B4";
                this.ctx.fillRect(0, 0, this.width, this.height);

                const bodies = Matter.Composite.allBodies(this.engine.world);
                bodies.forEach(body => {
                    if (body.isStatic) return;
                    const r = body.circleRadius - 1.5; 
                    this.ctx.save();
                    this.ctx.translate(body.position.x, body.position.y);
                    this.ctx.rotate(body.angle);
                    this.drawCircle(0, 0, r, body.gameValue);
                    this.ctx.restore();
                });

                if (this.currentBall && !this.deleteMode && !this.isPaused) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.currentBall.x, this.currentBall.y);
                    this.ctx.lineTo(this.currentBall.x, this.height);
                    this.ctx.strokeStyle = "rgba(120,120,120,0.3)";
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([6, 6]);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    this.drawCircle(this.currentBall.x, this.currentBall.y, this.currentBall.radius - 1.5, this.currentBall.value);
                }
                
                if (this.deleteMode) {
                    this.ctx.fillStyle = "rgba(0,0,0,0.5)";
                    this.ctx.fillRect(0, 0, this.width, this.height);
                    this.ctx.fillStyle = "#fff";
                    this.ctx.font = "bold 18px Nunito";
                    this.ctx.textAlign = "center";
                    this.ctx.fillText("–ù–∞–∂–º–∏ –Ω–∞ —à–∞—Ä", this.width/2, 120);
                }
            }

            drawCircle(x, y, r, value) {
                const color = CONFIG.colors[value] || "#3c3a32";
                this.ctx.beginPath();
                this.ctx.arc(x, y, Math.max(0, r), 0, Math.PI * 2);
                this.ctx.fillStyle = color;
                this.ctx.fill();
                const grad = this.ctx.createRadialGradient(x - r/3, y - r/3, r/6, x, y, r);
                grad.addColorStop(0, "rgba(255,255,255,0.4)");
                grad.addColorStop(1, "rgba(0,0,0,0)");
                this.ctx.fillStyle = grad;
                this.ctx.fill();
                this.ctx.fillStyle = CONFIG.textColors[value] || "#f9f6f2";
                this.ctx.font = `900 ${Math.max(10, r * 0.6)}px Nunito`;
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                this.ctx.fillText(value, x, y + 1);
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                const screen = document.getElementById('pause-screen');
                if (this.isPaused) { Matter.Runner.stop(this.runner); screen.classList.remove('hidden'); }
                else { Matter.Runner.run(this.runner, this.engine); screen.classList.add('hidden'); }
            }

            gameOver() {
                this.isPlaying = false;
                Matter.Runner.stop(this.runner);
                
                // –†–µ–∫–ª–∞–º–∞
                showInterstitialAd();

                let max = 0;
                Matter.Composite.allBodies(this.engine.world).forEach(b => { if(b.gameValue > max) max = b.gameValue; });
                
                // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                this.data.updateScore(this.score, max);
                this.data.gameFinished();

                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
                document.getElementById('final-score').innerText = this.score;
                document.getElementById('gameover-screen').classList.remove('hidden');
            }

            restart() {
                document.getElementById('gameover-screen').classList.add('hidden');
                document.getElementById('danger-line').style.opacity = 0;
                const currentLevelId = CONFIG.levels.find(l => l.width === this.width).id;
                this.start(currentLevelId);
            }

            quitToMenu() {
                this.isPlaying = false;
                Matter.Runner.stop(this.runner);
                ui.showScreen('menu');
            }

            updateUI() { document.getElementById('score-display').innerText = this.score; }
        }

        const ui = {
            screens: { menu: document.getElementById('main-menu'), game: document.getElementById('game-wrapper') },
            
            init() {
                this.renderLevelSelect();
                this.updateStatsValues();
                this.updateSettingsUI();
            },

            updateStatsValues() {
                const d = game.data.data;
                document.getElementById('stat-total-games').innerText = d.totalGames;
                document.getElementById('stat-max-tile').innerText = d.maxTile;
                document.getElementById('stat-high-score').innerText = d.highScore;
                document.getElementById('stat-unlocked-levels').innerText = `${d.unlockedLevels.length}/${CONFIG.levels.length}`;
            },

            updateSettingsUI() {
                const d = game.data.data;
                const themeBtn = document.getElementById('theme-btn');
                const soundBtn = document.getElementById('sound-btn');
                
                themeBtn.innerText = d.theme === 'light' ? '–°–≤–µ—Ç–ª–∞—è' : '–¢–µ–º–Ω–∞—è';
                themeBtn.className = `px-4 py-2 rounded-lg font-bold text-white transition-colors ${d.theme === 'light' ? 'bg-[#8f7a66]' : 'bg-gray-600'}`;
                
                soundBtn.innerText = d.sound ? '–í–ö–õ' : '–í–´–ö–õ';
                soundBtn.className = `px-4 py-2 rounded-lg font-bold text-white transition-colors ${d.sound ? 'bg-[#22c55e]' : 'bg-red-500'}`;
            },

            renderLevelSelect() {
                const container = document.getElementById('level-select');
                container.innerHTML = '';
                CONFIG.levels.forEach(lvl => {
                    const isUnlocked = game.data.data.unlockedLevels.includes(lvl.id);
                    const div = document.createElement('div');
                    let classes = "p-4 rounded-xl flex justify-between items-center cursor-pointer transition-all relative overflow-hidden ";
                    classes += isUnlocked 
                        ? "shadow hover:shadow-md border-l-4 border-[#edc22e]" 
                        : "opacity-60 border-l-4 border-gray-300 locked";
                    div.style.background = isUnlocked ? "var(--card-bg)" : "var(--card-locked)";
                    div.style.color = "var(--text-color)";
                    
                    div.className = classes;
                    div.onclick = () => { if(isUnlocked) game.start(lvl.id); };
                    div.innerHTML = `
                        <div>
                            <div class="font-bold">${lvl.name}</div>
                            <div class="text-xs opacity-70">${lvl.desc}</div>
                        </div>
                        ${isUnlocked ? '<i class="fas fa-play text-[#edc22e]"></i>' : `<span class="text-[10px] font-bold text-white bg-gray-400 px-2 py-1 rounded">–°—á–µ—Ç: ${lvl.scoreReq}</span>`}
                    `;
                    container.appendChild(div);
                });
            },
            
            toggleTheme() {
                game.data.toggleTheme();
                this.updateSettingsUI();
            },

            toggleSound() {
                game.data.toggleSound();
                this.updateSettingsUI();
            },

            showScreen(name) {
                this.screens.menu.classList.add('hidden');
                this.screens.game.classList.add('hidden');
                document.getElementById('pause-screen').classList.add('hidden');
                document.getElementById('gameover-screen').classList.add('hidden');
                if (name === 'menu') { 
                    this.screens.menu.classList.remove('hidden'); 
                    this.init(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
                } 
                else if (name === 'game') { this.screens.game.classList.remove('hidden'); }
            },
            
            showSettings() { document.getElementById('settings-modal').classList.remove('hidden'); },
            showRules() { document.getElementById('rules-modal').classList.remove('hidden'); },
            showStats() { 
                this.updateStatsValues(); 
                document.getElementById('stats-modal').classList.remove('hidden'); 
            },
            hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        };

        const game = new Game(); // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∏–≥—Ä—ã
        
        window.onload = async () => {
            await initVK();
            await game.data.load(); // –ì—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
            ui.init(); // –†–∏—Å—É–µ–º UI
            game.resize(); 
        };

    </script>
</body>
</html>