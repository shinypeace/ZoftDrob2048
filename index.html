<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soft Drop 2048</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --bg-color: #FAF8EF;
            --text-color: #776e65;
            --header-bg: #bbada0;
            --score-bg: #cdc1b4;
            --score-text: #eee4da;
            --canvas-bg: #CDC1B4;
            --modal-bg: rgba(250, 248, 239, 0.95);
            --modal-shadow: rgba(0,0,0,0.15);
            --btn-bg: #faf8ef;
            --btn-text: #776e65;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --card-locked: #f3f4f6;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #e5e7eb;
            --header-bg: #374151;
            --score-bg: #4b5563;
            --score-text: #e5e7eb;
            --canvas-bg: #1f2937;
            --modal-bg: rgba(17, 24, 39, 0.95);
            --modal-shadow: rgba(0,0,0,0.5);
            --btn-bg: #374151;
            --btn-text: #e5e7eb;
            --card-bg: #1f2937;
            --card-border: #374151;
            --card-locked: #111827;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
            -webkit-user-select: none;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            justify-content: center; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ UI */
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            filter: drop-shadow(0 10px 20px var(--modal-shadow));
            /* –£–±–∏—Ä–∞–µ–º –º–∞—Ä–≥–∏–Ω—ã, —Ç–∞–∫ –∫–∞–∫ body —Ü–µ–Ω—Ç—Ä—É–µ—Ç —á–µ—Ä–µ–∑ flex */
        }

        #game-header {
            background: var(--header-bg);
            border-radius: 12px 12px 0 0;
            height: 70px;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            transition: background 0.3s;
        }

        .score-box {
            background: var(--score-bg);
            padding: 5px 15px;
            border-radius: 6px;
            color: var(--score-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            transition: background 0.3s;
        }

        canvas {
            display: block;
            border-radius: 0 0 12px 12px;
            background: var(--canvas-bg);
            transition: background 0.3s;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--btn-text);
            background: var(--btn-bg);
            font-size: 1.2rem;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: visible;
        }
        .control-btn:active { transform: scale(0.95); }
        
        .delete-active {
            background: #ff6b6b !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        
        .ad-badge {
            position: absolute;
            top: -6px; right: -6px;
            background-color: #3b82f6;
            color: white; font-size: 9px; font-weight: 900;
            padding: 2px 4px; border-radius: 4px;
            border: 2px solid var(--bg-color);
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .menu-modal {
            position: absolute; inset: 0; z-index: 50;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è) --- */
        .tutorial-container {
            position: relative; width: 120px; height: 160px;
            background: rgba(0,0,0,0.05); border-radius: 12px;
            margin: 0 auto 10px; overflow: hidden;
        }
        
        .t-ball {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; color: #776e65;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }
        
        .t-ball.val-2 { background: #eee4da; }
        
        .t-hand {
            position: absolute; font-size: 24px; top: 10px; left: 50%;
            transform: translateX(-50%);
            animation: handMove 3s infinite;
            z-index: 10;
        }

        .t-drop {
            left: 50%; top: 40px; margin-left: -15px; opacity: 0;
            animation: ballDrop 3s infinite;
        }

        .t-static {
            left: 50%; bottom: 10px; margin-left: -15px;
            animation: ballMergeBottom 3s infinite;
        }

        @keyframes handMove {
            0%, 10% { transform: translateX(-50%) scale(1); }
            20% { transform: translateX(-50%) scale(0.9); } /* Press */
            30% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1); }
        }

        @keyframes ballDrop {
            0%, 20% { top: 40px; opacity: 0; }
            25% { opacity: 1; }
            45% { top: 110px; opacity: 1; } /* Hit */
            50% { opacity: 0; } /* Disappear on merge */
            100% { opacity: 0; }
        }

        @keyframes ballMergeBottom {
            0%, 45% { transform: scale(1); background: #eee4da; opacity: 1; }
            45.1% { content: "2"; }
            50% { transform: scale(1.2); background: #ede0c8; } /* Pop */
            60% { transform: scale(1); background: #ede0c8; } /* 4 */
            85% { opacity: 1; }
            90% { opacity: 0; } 
            100% { opacity: 0; }
        }
        
        /* –•–∞–∫ –¥–ª—è —Å–º–µ–Ω—ã —Ü–∏—Ñ—Ä—ã —á–µ—Ä–µ–∑ CSS animation –≤ –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç–µ –±—ã–ª –±—ã —Å–ª–æ–∂–µ–Ω, 
           –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–∏–º –≤—Ç–æ—Ä–æ–π —à–∞—Ä–∏–∫ –¥–ª—è —Ü–∏—Ñ—Ä—ã 4, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö */
        .t-result {
            left: 50%; bottom: 10px; margin-left: -15px;
            background: #ede0c8; color: #776e65; opacity: 0;
            animation: showResult 3s infinite;
            z-index: 2;
        }
        
        @keyframes showResult {
            0%, 49% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            60% { transform: scale(1); }
            85% { opacity: 1; }
            90% { opacity: 0; }
            100% { opacity: 0; }
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } }
    </style>
</head>
<body>

    <!-- –û–±–µ—Ä—Ç–∫–∞ –∏–≥—Ä—ã -->
    <div id="game-wrapper" class="hidden">
        
        <!-- –®–∞–ø–∫–∞ -->
        <div id="game-header">
            <div class="score-box">
                <span class="text-[10px] font-bold uppercase tracking-wider opacity-70">–°—á–µ—Ç</span>
                <span id="score-display" class="text-xl font-bold leading-tight">0</span>
            </div>

            <div class="flex gap-3">
                <!-- –õ–∞—Å—Ç–∏–∫ -->
                <button id="btn-delete" onclick="game.sound.playClick(); game.tryActivateDelete()" class="control-btn" title="–£–¥–∞–ª–∏—Ç—å —à–∞—Ä">
                    <div class="ad-badge">AD</div>
                    <i class="fas fa-eraser"></i>
                </button>

                <!-- –ü–∞—É–∑–∞ -->
                <button onclick="game.sound.playClick(); game.togglePause()" class="control-btn" title="–ü–∞—É–∑–∞">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
        </div>

        <canvas id="world"></canvas>
        
        <!-- –õ–∏–Ω–∏—è –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
        <div id="danger-line" class="absolute w-full border-b-2 border-dashed border-red-400 opacity-0 transition-opacity duration-300 pointer-events-none z-20" style="top: 200px;">
            <span class="absolute right-2 -top-6 text-[10px] text-white font-bold bg-red-400 px-2 py-0.5 rounded-full shadow-sm">–û–ü–ê–°–ù–û–°–¢–¨</span>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ü–∞—É–∑—ã -->
        <div id="pause-screen" class="absolute inset-0 z-40 hidden flex flex-col items-center justify-center rounded-xl bounce-in" style="background: var(--modal-bg); backdrop-filter: blur(5px);">
            <h2 class="text-3xl font-black mb-6" style="color: var(--text-color);">–ü–∞—É–∑–∞</h2>
            <div class="w-48 space-y-3">
                <button onclick="game.sound.playClick(); game.togglePause()" class="w-full bg-[#edc22e] text-white py-3 rounded-lg font-bold shadow-md menu-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button onclick="game.sound.playClick(); game.quitToMenu()" class="w-full bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow-md menu-btn">–ú–µ–Ω—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω Game Over -->
        <div id="gameover-screen" class="absolute inset-0 z-40 hidden flex flex-col items-center justify-center rounded-xl bounce-in" style="background: var(--modal-bg); backdrop-filter: blur(5px);">
            <h2 class="text-4xl font-black mb-2" style="color: var(--text-color);">–§–∏–Ω–∏—Ç–∞!</h2>
            <p class="mb-6 text-sm font-semibold opacity-70" style="color: var(--text-color);">–ú–µ—Å—Ç–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç</p>
            
            <div class="rounded-lg px-8 py-4 mb-8 text-center shadow-inner" style="background: var(--score-bg); color: var(--score-text);">
                <div class="text-xs uppercase font-bold opacity-70">–í–∞—à —Å—á–µ—Ç</div>
                <div id="final-score" class="text-4xl font-black">0</div>
            </div>

            <div class="w-56 space-y-3">
                <button onclick="game.sound.playClick(); game.restart()" class="w-full bg-[#edc22e] text-white py-3 rounded-lg font-bold shadow-lg menu-btn hover:bg-[#e5ba2a]">
                    <i class="fas fa-redo mr-2"></i> –ó–∞–Ω–æ–≤–æ
                </button>
                <button onclick="game.sound.playClick(); game.quitToMenu()" class="w-full bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow-md menu-btn">
                    <i class="fas fa-home mr-2"></i> –ú–µ–Ω—é
                </button>
            </div>
        </div>
    </div>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="main-menu" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 transition-colors duration-300" style="background: var(--bg-color);">
        <div class="absolute top-4 right-4">
             <button onclick="game.sound.playClick(); ui.showSettings()" class="control-btn shadow-none bg-transparent hover:bg-black/5">
                <i class="fas fa-cog fa-lg"></i>
            </button>
        </div>

        <div class="text-center mb-6 slide-up">
            <div class="inline-block bg-[#edc22e] text-white text-5xl font-black p-4 rounded-xl shadow-lg mb-2">2048</div>
            <div class="text-3xl font-bold tracking-widest uppercase" style="color: var(--text-color);">Soft Drop</div>
        </div>
        
        <div class="w-full max-w-sm space-y-3 slide-up" style="animation-delay: 0.1s;">
            <!-- –ö–Ω–æ–ø–∫–∞ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (–ø–æ—è–≤–∏—Ç—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ–π–≤) -->
            <button id="btn-continue" onclick="game.sound.playClick(); game.loadAndContinue()" class="hidden w-full bg-[#edc22e] text-white py-4 rounded-xl font-bold shadow-lg menu-btn mb-4 text-lg">
                <i class="fas fa-play mr-2"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>

            <div class="text-sm font-bold uppercase tracking-wide mb-2 ml-1 opacity-70" style="color: var(--text-color);">–ù–æ–≤–∞—è –∏–≥—Ä–∞</div>
            <div id="level-select" class="grid grid-cols-1 gap-3">
                <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="game.sound.playClick(); ui.showRules()" class="bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow hover:bg-[#7f6a56] menu-btn text-sm">
                    –ö–∞–∫ –∏–≥—Ä–∞—Ç—å
                </button>
                <button onclick="game.sound.playClick(); ui.showStats()" class="bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow hover:bg-[#7f6a56] menu-btn text-sm">
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ù–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-6" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" style="color: var(--text-color);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="game.sound.playClick(); ui.hideModal('settings-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--card-locked);">
                    <span class="font-bold" style="color: var(--text-color);">–¢–µ–º–∞</span>
                    <button id="theme-btn" onclick="game.sound.playClick(); ui.toggleTheme()" class="px-4 py-2 rounded-lg font-bold text-white transition-colors bg-[#8f7a66]">
                        –°–≤–µ—Ç–ª–∞—è
                    </button>
                </div>

                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--card-locked);">
                    <span class="font-bold" style="color: var(--text-color);">–ó–≤—É–∫–∏</span>
                    <button id="sound-btn" onclick="game.sound.playClick(); ui.toggleSound()" class="px-4 py-2 rounded-lg font-bold text-white transition-colors bg-[#22c55e]">
                        –í–ö–õ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ü—Ä–∞–≤–∏–ª -->
    <div id="rules-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-5" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--card-border);">
                <h3 class="text-lg font-bold" style="color: var(--text-color);">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h3>
                <button onclick="game.sound.playClick(); ui.hideModal('rules-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="tutorial-container">
                <div class="t-hand">üëÜ</div>
                <div class="t-ball t-drop val-2">2</div>
                <div class="t-ball t-static val-2">2</div>
                <div class="t-ball t-result val-4">4</div>
            </div>

            <div class="text-sm space-y-4" style="color: var(--text-color);">
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#bbada0] flex items-center justify-center text-white font-bold shrink-0 text-xs">1</div>
                    <p>–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–≥—É—Ä—É.</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#f65e3b] flex items-center justify-center text-white font-bold shrink-0 text-xs">2</div>
                    <p>–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —á–∏—Å–ª–∞ —Å–ª–∏–≤–∞—é—Ç—Å—è –≤ –Ω–æ–≤–æ–µ.</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#edc22e] flex items-center justify-center text-white font-bold shrink-0 text-xs">
                        <i class="fas fa-eraser"></i>
                    </div>
                    <p>–õ–∞—Å—Ç–∏–∫ —É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω—é—é —Ñ–∏–≥—É—Ä—É.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="stats-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-5" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--card-border);">
                <h3 class="text-lg font-bold" style="color: var(--text-color);">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <button onclick="game.sound.playClick(); ui.hideModal('stats-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="text-center mb-6">
                <div class="text-xs uppercase opacity-60 mb-1" style="color: var(--text-color);">–†–µ–∫–æ—Ä–¥ –æ—á–∫–æ–≤</div>
                <div id="stat-high-score" class="text-4xl font-black text-[#edc22e] tracking-tight">0</div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="p-3 rounded-xl text-center" style="background: var(--card-locked);">
                    <div class="text-[10px] uppercase opacity-60" style="color: var(--text-color);">–í—Å–µ–≥–æ –∏–≥—Ä</div>
                    <div id="stat-total-games" class="text-lg font-bold" style="color: var(--text-color);">0</div>
                </div>
                <div class="p-3 rounded-xl text-center" style="background: var(--card-locked);">
                    <div class="text-[10px] uppercase opacity-60" style="color: var(--text-color);">–ú–∞–∫—Å. –§–∏–≥—É—Ä–∞</div>
                    <div id="stat-max-tile" class="text-lg font-bold text-[#f67c5f]">0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            colors: {
                2: "#eee4da", 4: "#ede0c8", 8: "#f2b179", 16: "#f59563",
                32: "#f67c5f", 64: "#f65e3b", 128: "#edcf72", 256: "#edcc61",
                512: "#edc850", 1024: "#edc53f", 2048: "#edc22e", 4096: "#3c3a32"
            },
            textColors: { 2: "#776e65", 4: "#776e65", 8: "#f9f6f2" },
            // –£—Ä–æ–≤–Ω–∏ —Å —Ç–∏–ø–∞–º–∏ —Ñ–∏–≥—É—Ä: circle, square, chaos
            levels: [
                { id: 'classic', name: '–ö–ª–∞—Å—Å–∏–∫–∞', scoreReq: 0, width: 340, desc: '–®–∞—Ä—ã', type: 'circle' },
                { id: 'squares', name: '–ö—É–±–∏–∑–º', scoreReq: 2000, width: 280, desc: '–ö–≤–∞–¥—Ä–∞—Ç—ã', type: 'square' },
                { id: 'chaos', name: '–•–∞–æ—Å', scoreReq: 5000, width: 390, desc: '–†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã', type: 'chaos' }
            ]
        };

        // --- VK ---
        let vkUserId = null;
        async function initVK() {
            try {
                if(window.vkBridge) {
                    await window.vkBridge.send('VKWebAppInit');
                    try {
                        const user = await window.vkBridge.send('VKWebAppGetUserInfo');
                        vkUserId = user.id;
                    } catch (e) {}
                    window.vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(()=>{});
                }
            } catch (e) {}
        }
        async function showRewardedAd() {
            if (!window.vkBridge) return true;
            try { return (await window.vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' })).result; } catch { return false; }
        }
        function showInterstitialAd() {
            if (window.vkBridge) window.vkBridge.send('VKWebAppShowInterstitialAd').catch(()=>{});
        }

        // --- AUDIO ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = true;
            }
            playTone(freq, type, duration) {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, t);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(t + duration);
            }
            playPop(value) { this.playTone(200 + (Math.log2(value) * 60), 'sine', 0.2); }
            playDelete() { this.playTone(150, 'square', 0.3); }
            playDrop() { this.playTone(80, 'triangle', 0.1); }
            playClick() { this.playTone(400, 'sine', 0.05); } // –ó–≤—É–∫ –∫–ª–∏–∫–∞
            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
            toggle(state) { this.enabled = state; }
        }

        // --- DATA & SAVES ---
        class DataManager {
            constructor() {
                this.data = {
                    highScore: 0, totalGames: 0, maxTile: 2, unlockedLevels: ['classic', 'squares', 'chaos'], // –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∞
                    theme: 'light', sound: true,
                    savedGame: null // –°–ª–æ—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                };
            }
            async load() {
                const local = localStorage.getItem('softdrop_save_v3');
                if (local) this.data = { ...this.data, ...JSON.parse(local) };
                if (vkUserId && window.vkBridge) {
                    try {
                        const r = await window.vkBridge.send('VKWebAppStorageGet', { keys: [`save_v3_${vkUserId}`] });
                        if (r.keys[0]?.value) this.data = { ...this.data, ...JSON.parse(r.keys[0].value) };
                    } catch (e) {}
                }
                this.applySettings();
            }
            async save() {
                const val = JSON.stringify(this.data);
                localStorage.setItem('softdrop_save_v3', val);
                if (vkUserId && window.vkBridge) {
                    window.vkBridge.send('VKWebAppStorageSet', { key: `save_v3_${vkUserId}`, value: val }).catch(()=>{});
                }
            }
            saveGame(gameState) {
                this.data.savedGame = gameState;
                this.save();
                ui.updateContinueButton();
            }
            clearSavedGame() {
                this.data.savedGame = null;
                this.save();
                ui.updateContinueButton();
            }
            updateScore(score, maxTile) {
                if (score > this.data.highScore) this.data.highScore = score;
                if (maxTile > this.data.maxTile) this.data.maxTile = maxTile;
                this.save();
            }
            gameFinished() { this.data.totalGames++; this.clearSavedGame(); }
            toggleTheme() { this.data.theme = this.data.theme === 'light' ? 'dark' : 'light'; this.applySettings(); this.save(); return this.data.theme; }
            toggleSound() { this.data.sound = !this.data.sound; this.applySettings(); this.save(); return this.data.sound; }
            applySettings() {
                document.documentElement.setAttribute('data-theme', this.data.theme);
                game.sound.toggle(this.data.sound);
            }
        }

        // --- GAME ENGINE ---
        class Game {
            constructor() {
                // –í–ê–ñ–ù–û: enableSleeping: false –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ —Ç–µ–ª –≤ –≤–æ–∑–¥—É—Ö–µ
                this.engine = Matter.Engine.create({ enableSleeping: false });
                this.runner = Matter.Runner.create();
                this.renderCanvas = document.getElementById('world');
                this.ctx = this.renderCanvas.getContext('2d');
                this.width = 340; this.height = window.innerHeight * 0.75;
                this.score = 0;
                this.isPlaying = false;
                this.currentLevelId = 'classic';
                this.sound = new SoundManager();
                this.data = new DataManager();
                window.addEventListener('resize', () => { if(this.isPlaying) this.resize(); });
                this.setupInput();
                this.setupPhysicsEvents();
            }

            resize() {
                this.height = Math.min(window.innerHeight * 0.75, 800);
                this.renderCanvas.width = this.width;
                this.renderCanvas.height = this.height;
                document.getElementById('game-wrapper').style.width = `${this.width}px`;
                if (this.ground) Matter.Body.setPosition(this.ground, { x: this.width/2, y: this.height + 50 });
                const dangerLine = document.getElementById('danger-line');
                if (dangerLine) dangerLine.style.top = `${this.height * 0.25}px`; 
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏—è
            createBody(x, y, value, isStatic = false) {
                const levelType = CONFIG.levels.find(l => l.id === this.currentLevelId).type;
                let body;
                const size = 22 + (Math.log2(value) * 2.5); // –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä
                const opts = {
                    restitution: 0.2, // –ú–µ–Ω—å—à–µ –æ—Ç—Å–∫–æ–∫ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–æ–≤
                    friction: 0.5,
                    frictionStatic: 0.6,
                    label: `body-${value}`,
                    isStatic: isStatic
                };

                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
                let shape = 'circle';
                if (levelType === 'square') shape = 'rectangle';
                else if (levelType === 'chaos') {
                    // –•–∞–æ—Å: 2-–∫—Ä—É–≥, 4-–∫–≤–∞–¥—Ä–∞—Ç, 8-—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫, 16-–ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫...
                    if (value === 2) shape = 'circle';
                    else if (value === 4) shape = 'rectangle';
                    else if (value === 8) shape = 'polygon-3';
                    else if (value === 16) shape = 'polygon-5';
                    else if (value === 32) shape = 'polygon-6';
                    else shape = 'circle';
                }

                if (shape === 'rectangle') {
                    // –ö–≤–∞–¥—Ä–∞—Ç (size * 1.8 —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–æ–≤–ø–∞–¥–∞–ª –ø–æ –ø–ª–æ—â–∞–¥–∏ —Å –∫—Ä—É–≥–æ–º)
                    body = Matter.Bodies.rectangle(x, y, size * 1.8, size * 1.8, { ...opts, chamfer: { radius: 4 } });
                    body.gameShape = 'rectangle';
                } else if (shape.startsWith('polygon-')) {
                    const sides = parseInt(shape.split('-')[1]);
                    body = Matter.Bodies.polygon(x, y, sides, size, opts);
                    body.gameShape = 'polygon';
                } else {
                    body = Matter.Bodies.circle(x, y, size, opts);
                    body.gameShape = 'circle';
                }

                body.gameValue = value;
                return body;
            }

            start(levelId, loadFromSave = false) {
                this.currentLevelId = levelId;
                const level = CONFIG.levels.find(l => l.id === levelId);
                this.width = level.width;
                this.resize();

                Matter.World.clear(this.engine.world);
                Matter.Engine.clear(this.engine);
                
                this.score = 0;
                this.isPlaying = true;
                this.isPaused = false;
                this.deleteMode = false;
                
                // –°—Ç–µ–Ω—ã
                this.leftWall = Matter.Bodies.rectangle(-50, this.height/2, 100, this.height * 3, { isStatic: true, friction: 0.1 });
                this.rightWall = Matter.Bodies.rectangle(this.width + 50, this.height/2, 100, this.height * 3, { isStatic: true, friction: 0.1 });
                this.ground = Matter.Bodies.rectangle(this.width/2, this.height + 50, this.width + 200, 100, { isStatic: true, friction: 0.5 });
                Matter.World.add(this.engine.world, [this.ground, this.leftWall, this.rightWall]);

                if (loadFromSave && this.data.data.savedGame) {
                    this.restoreGame(this.data.data.savedGame);
                } else {
                    this.spawnNextPreview();
                }

                this.updateUI();
                Matter.Runner.run(this.runner, this.engine);
                this.sound.resume();
                this.loop();
                ui.showScreen('game');
            }

            restoreGame(saveData) {
                this.score = saveData.score;
                this.currentLevelId = saveData.levelId;
                this.nextValue = saveData.nextValue;
                
                saveData.bodies.forEach(b => {
                    const body = this.createBody(b.x, b.y, b.value);
                    Matter.Body.setAngle(body, b.angle);
                    Matter.World.add(this.engine.world, body);
                });
                
                this.spawnNextPreview(this.nextValue);
            }

            saveState() {
                if (!this.isPlaying) return;
                const bodies = Matter.Composite.allBodies(this.engine.world)
                    .filter(b => !b.isStatic && b.gameValue)
                    .map(b => ({ x: b.position.x, y: b.position.y, angle: b.angle, value: b.gameValue }));
                
                this.data.saveGame({
                    levelId: this.currentLevelId,
                    score: this.score,
                    nextValue: this.nextValue,
                    bodies: bodies
                });
            }
            
            loadAndContinue() {
                if (this.data.data.savedGame) {
                    this.start(this.data.data.savedGame.levelId, true);
                }
            }

            spawnNextPreview(forceValue = null) {
                if (forceValue) this.nextValue = forceValue;
                else {
                    const r = Math.random();
                    if (r < 0.6) this.nextValue = 2; else if (r < 0.85) this.nextValue = 4;
                    else if (r < 0.95) this.nextValue = 8; else this.nextValue = 16;
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–µ —Ç–µ–ª–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é
                this.currentBall = { x: this.width / 2, y: 60, value: this.nextValue };
                // –î–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –Ω–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Ä–∞–∑–º–µ—Ä, —Å–æ–∑–¥–∞–¥–∏–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ç–µ–ª–æ —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ä–∞–¥–∏—É—Å
                const tempBody = this.createBody(0,0, this.nextValue);
                // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞–¥–∏—É—Å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –±–µ—Ä–µ–º –ø–æ–ª–æ–≤–∏–Ω—É —à–∏—Ä–∏–Ω—ã)
                this.currentBall.radius = tempBody.circleRadius || (tempBody.bounds.max.x - tempBody.bounds.min.x)/2;
                this.currentBall.shape = tempBody.gameShape;
            }

            dropBall() {
                if (!this.currentBall || this.isPaused || !this.isPlaying || this.deleteMode) return;
                
                const body = this.createBody(this.currentBall.x, this.currentBall.y, this.currentBall.value);
                Matter.World.add(this.engine.world, body);
                
                this.sound.playDrop();
                this.currentBall = null;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –±—Ä–æ—Å–∫–∞
                setTimeout(() => this.saveState(), 100);

                setTimeout(() => { if (this.isPlaying) this.spawnNextPreview(); }, 400);
            }

            setupPhysicsEvents() {
                Matter.Events.on(this.engine, 'collisionStart', (event) => {
                    event.pairs.forEach((pair) => {
                        const A = pair.bodyA; const B = pair.bodyB;
                        if (A.isStatic || B.isStatic) return;
                        if (A.gameValue === B.gameValue && !A.toRemove && !B.toRemove) {
                            A.toRemove = true; B.toRemove = true;
                            this.mergeBodies(A, B);
                        }
                    });
                });
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–π–º–æ–≤–µ—Ä–∞ —Ä–µ–∂–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
                setInterval(() => { if(this.isPlaying && !this.isPaused) this.checkGameOver(); }, 1000);
            }

            mergeBodies(A, B) {
                const newValue = A.gameValue * 2;
                const midX = (A.position.x + B.position.x) / 2;
                const midY = (A.position.y + B.position.y) / 2;
                Matter.World.remove(this.engine.world, [A, B]);
                
                const newBody = this.createBody(midX, midY, newValue);
                Matter.World.add(this.engine.world, newBody);
                
                this.score += newValue;
                this.sound.playPop(newValue);
                this.updateUI();
                this.saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è
            }

            checkGameOver() {
                const dangerY = this.height * 0.25; 
                let dangerCount = 0;
                const bodies = Matter.Composite.allBodies(this.engine.world);
                bodies.forEach(b => { 
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø–∞–¥–∞—é—â–∏–µ —Ç–µ–ª–∞
                    if (!b.isStatic && b.position.y < dangerY && Math.abs(b.velocity.y) < 0.1 && Math.abs(b.velocity.x) < 0.1) dangerCount++; 
                });
                
                const line = document.getElementById('danger-line');
                if(line) line.style.opacity = dangerCount > 0 ? '1' : '0';
                
                // –ï—Å–ª–∏ –∫–æ—Å–Ω—É–ª–∏—Å—å —Å–∞–º–æ–≥–æ –≤–µ—Ä—Ö–∞ (–∫—Ä–∏—Ç–∏—á–Ω–æ)
                const topTouch = bodies.some(b => !b.isStatic && b.position.y < 20);

                if (dangerCount > 1 || topTouch) {
                    setTimeout(() => {
                       if(this.isPlaying && (document.getElementById('danger-line')?.style.opacity === '1' || topTouch)) {
                           this.gameOver();
                       }
                    }, 1500);
                }
            }

            setupInput() {
                const getPos = (e) => {
                    const rect = this.renderCanvas.getBoundingClientRect();
                    let t = (e.touches && e.touches.length > 0) ? e.touches[0] : (e.changedTouches && e.changedTouches.length > 0 ? e.changedTouches[0] : e);
                    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
                };
                const handleMove = (pos) => {
                    if (this.deleteMode || !this.currentBall || this.isPaused) return;
                    const r = this.currentBall.radius;
                    this.currentBall.x = Math.max(r, Math.min(this.width - r, pos.x));
                };
                const handleClick = (e) => {
                    e.preventDefault();
                    if (this.deleteMode) this.tryDeleteAt(getPos(e)); else this.dropBall();
                };
                this.renderCanvas.addEventListener('mousemove', e => handleMove(getPos(e)));
                this.renderCanvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(getPos(e)); }, { passive: false });
                this.renderCanvas.addEventListener('mousedown', handleClick);
                this.renderCanvas.addEventListener('touchend', handleClick);
            }

            async tryActivateDelete() {
                if (this.deleteMode) { this.toggleDeleteMode(); return; }
                const success = await showRewardedAd();
                if (success) this.toggleDeleteMode();
            }

            toggleDeleteMode() {
                this.deleteMode = !this.deleteMode;
                const btn = document.getElementById('btn-delete');
                const canvas = document.getElementById('world');
                if (this.deleteMode) { btn.classList.add('delete-active'); canvas.classList.add('cursor-delete'); }
                else { btn.classList.remove('delete-active'); canvas.classList.remove('cursor-delete'); }
            }

            tryDeleteAt(pos) {
                const bodies = Matter.Composite.allBodies(this.engine.world);
                const clickedBody = bodies.find(b => {
                    if (b.isStatic) return false;
                    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ bounding box –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–≥—É—Ä (–±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
                    return Matter.Bounds.contains(b.bounds, pos);
                });
                if (clickedBody) {
                    Matter.World.remove(this.engine.world, clickedBody);
                    this.sound.playDelete();
                    this.toggleDeleteMode();
                    this.saveState();
                }
            }

            loop() {
                if (!this.isPlaying) return;
                requestAnimationFrame(() => this.loop());
                
                const canvasColor = getComputedStyle(document.body).getPropertyValue('--canvas-bg').trim();
                this.ctx.fillStyle = canvasColor || "#CDC1B4";
                this.ctx.fillRect(0, 0, this.width, this.height);

                const bodies = Matter.Composite.allBodies(this.engine.world);
                bodies.forEach(body => {
                    if (body.isStatic) return;
                    this.ctx.save();
                    this.ctx.translate(body.position.x, body.position.y);
                    this.ctx.rotate(body.angle);
                    this.drawBody(body.gameShape, body.circleRadius || (body.bounds.max.x - body.bounds.min.x)/2, body.gameValue);
                    this.ctx.restore();
                });

                if (this.currentBall && !this.deleteMode && !this.isPaused) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.currentBall.x, this.currentBall.y);
                    this.ctx.lineTo(this.currentBall.x, this.height);
                    this.ctx.strokeStyle = "rgba(120,120,120,0.3)";
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([6, 6]);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    this.drawBody(this.currentBall.shape, this.currentBall.radius, this.currentBall.value, this.currentBall.x, this.currentBall.y);
                }
                
                if (this.deleteMode) {
                    this.ctx.fillStyle = "rgba(0,0,0,0.5)";
                    this.ctx.fillRect(0, 0, this.width, this.height);
                    this.ctx.fillStyle = "#fff";
                    this.ctx.font = "bold 18px Nunito";
                    this.ctx.textAlign = "center";
                    this.ctx.fillText("–ù–∞–∂–º–∏ –Ω–∞ —Ñ–∏–≥—É—Ä—É", this.width/2, 120);
                }
            }

            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ä–∏—Å–æ–≤–∞–ª–∫–∞ —Ñ–∏–≥—É—Ä
            drawBody(shape, size, value, x=0, y=0) {
                const color = CONFIG.colors[value] || "#3c3a32";
                this.ctx.fillStyle = color;
                this.ctx.beginPath();
                
                if (shape === 'rectangle') {
                    // –†–∏—Å—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ 0,0 (—Ç–∞–∫ –∫–∞–∫ —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ translate/rotate)
                    // –†–∞–∑–º–µ—Ä size —Ç—É—Ç - —ç—Ç–æ –ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã –ø—Ä–∏–º–µ—Ä–Ω–æ
                    const w = size * 1.8; // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞, —Ç.–∫. size –±—ã–ª —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∏–∑ —Ä–∞–¥–∏—É—Å–∞ –∫—Ä—É–≥–∞
                    this.ctx.roundRect(x - w/2, y - w/2, w, w, 4);
                } else if (shape === 'polygon') {
                     // –ü–æ–ª–∏–≥–æ–Ω—ã Matter.js
                     // –¢—É—Ç —Å–ª–æ–∂–Ω–µ–µ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—ã–π –ø–æ–ª–∏–≥–æ–Ω –±–µ–∑ –≤–µ—Ä—à–∏–Ω, 
                     // –Ω–æ –¥–ª—è –ø—Ä–µ–≤—å—é (–≥–¥–µ x,y –∑–∞–¥–∞–Ω—ã) —Ä–∏—Å—É–µ–º –∫—Ä—É–≥, –∞ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–ª (–≥–¥–µ x=0,y=0) –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –≤–µ—Ä—à–∏–Ω—ã?
                     // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä—É–≥ –¥–ª—è —Å–ø–∞–≤–Ω–µ—Ä–∞ –ø–æ–ª–∏–≥–æ–Ω–æ–≤, 
                     // –Ω–æ –¥–ª—è —Ç–µ–ª –Ω–∞ —Å—Ü–µ–Ω–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å vertices –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ –ø—Ä–æ—â–µ —Ä–∏—Å–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫
                     // –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –≤–Ω—É—Ç—Ä–∏ translate/rotate, —Ä–∏—Å—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫
                     // (—É–ø—Ä–æ—â–µ–Ω–∏–µ: —Ä–∏—Å—É–µ–º –∫—Ä—É–≥ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–∏–≥–æ–Ω–æ–≤ –≤ –ø—Ä–µ–≤—å—é, –Ω–æ –Ω–∞ –ø–æ–ª–µ –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–ª–∏–≥–æ–Ω–∞–º–∏)
                     // –ß—Ç–æ–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø–æ–ª–∏–≥–æ–Ω –≤ loop, –Ω–∞–º –Ω—É–∂–Ω—ã –≤–µ—Ä—à–∏–Ω—ã.
                     // –¢–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º vertices –≤ drawBody, –Ω–∞—Ä–∏—Å—É–µ–º –∫—Ä—É–≥ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏–ª–∏ –ø–µ—Ä–µ–¥–µ–ª–∞–µ–º loop.
                     // –î–õ–Ø –ü–†–û–°–¢–û–¢–´: –í —ç—Ç–æ–º –∫–æ–¥–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∏–≥–æ–Ω—ã —Ç–æ–∂–µ –∫–∞–∫ –∫—Ä—É–≥–∏ —Å "—É–≥–ª–∞–º–∏" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫—Ä—É–≥–∏.
                     // –ù–æ –ª—É—á—à–µ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø—Ä–∏–º–∏—Ç–∏–≤.
                     this.ctx.arc(x, y, size, 0, Math.PI * 2);
                } else {
                    // –ö—Ä—É–≥
                    this.ctx.arc(x, y, size, 0, Math.PI * 2);
                }
                
                this.ctx.fill();

                // –ë–ª–∏–∫
                const grad = this.ctx.createRadialGradient(x - size/3, y - size/3, size/6, x, y, size);
                grad.addColorStop(0, "rgba(255,255,255,0.4)");
                grad.addColorStop(1, "rgba(0,0,0,0)");
                this.ctx.fillStyle = grad;
                this.ctx.fill();

                // –¢–µ–∫—Å—Ç
                this.ctx.fillStyle = CONFIG.textColors[value] || "#f9f6f2";
                this.ctx.font = `900 ${Math.max(10, size * 0.6)}px Nunito`;
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                this.ctx.fillText(value, x, y + 1);
            }

            gameOver() {
                this.isPlaying = false;
                Matter.Runner.stop(this.runner);
                showInterstitialAd();
                
                let max = 0;
                Matter.Composite.allBodies(this.engine.world).forEach(b => { if(b.gameValue > max) max = b.gameValue; });
                
                this.data.updateScore(this.score, max);
                this.data.gameFinished();

                document.getElementById('final-score').innerText = this.score;
                document.getElementById('gameover-screen').classList.remove('hidden');
            }

            restart() {
                document.getElementById('gameover-screen').classList.add('hidden');
                document.getElementById('danger-line').style.opacity = 0;
                this.start(this.currentLevelId);
            }

            quitToMenu() {
                this.saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
                this.isPlaying = false;
                Matter.Runner.stop(this.runner);
                ui.showScreen('menu');
            }

            updateUI() { document.getElementById('score-display').innerText = this.score; }
        }

        const ui = {
            screens: { menu: document.getElementById('main-menu'), game: document.getElementById('game-wrapper') },
            
            init() {
                this.renderLevelSelect();
                this.updateStatsValues();
                this.updateSettingsUI();
                this.updateContinueButton();
            },

            updateContinueButton() {
                const btn = document.getElementById('btn-continue');
                if (game.data.data.savedGame) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            },

            updateStatsValues() {
                const d = game.data.data;
                document.getElementById('stat-total-games').innerText = d.totalGames;
                document.getElementById('stat-max-tile').innerText = d.maxTile;
                document.getElementById('stat-high-score').innerText = d.highScore;
            },

            updateSettingsUI() {
                const d = game.data.data;
                const themeBtn = document.getElementById('theme-btn');
                const soundBtn = document.getElementById('sound-btn');
                
                themeBtn.innerText = d.theme === 'light' ? '–°–≤–µ—Ç–ª–∞—è' : '–¢–µ–º–Ω–∞—è';
                themeBtn.className = `px-4 py-2 rounded-lg font-bold text-white transition-colors ${d.theme === 'light' ? 'bg-[#8f7a66]' : 'bg-gray-600'}`;
                
                soundBtn.innerText = d.sound ? '–í–ö–õ' : '–í–´–ö–õ';
                soundBtn.className = `px-4 py-2 rounded-lg font-bold text-white transition-colors ${d.sound ? 'bg-[#22c55e]' : 'bg-red-500'}`;
            },

            renderLevelSelect() {
                const container = document.getElementById('level-select');
                container.innerHTML = '';
                CONFIG.levels.forEach(lvl => {
                    const isUnlocked = game.data.data.unlockedLevels.includes(lvl.id);
                    const div = document.createElement('div');
                    let classes = "p-4 rounded-xl flex justify-between items-center cursor-pointer transition-all relative overflow-hidden ";
                    classes += isUnlocked 
                        ? "shadow hover:shadow-md border-l-4 border-[#edc22e]" 
                        : "opacity-60 border-l-4 border-gray-300 locked";
                    div.style.background = isUnlocked ? "var(--card-bg)" : "var(--card-locked)";
                    div.style.color = "var(--text-color)";
                    
                    div.className = classes;
                    div.onclick = () => { if(isUnlocked) { game.sound.playClick(); game.start(lvl.id); } };
                    div.innerHTML = `
                        <div>
                            <div class="font-bold">${lvl.name}</div>
                            <div class="text-xs opacity-70">${lvl.desc}</div>
                        </div>
                        ${isUnlocked ? '<i class="fas fa-play text-[#edc22e]"></i>' : `<span class="text-[10px] font-bold text-white bg-gray-400 px-2 py-1 rounded">–°—á–µ—Ç: ${lvl.scoreReq}</span>`}
                    `;
                    container.appendChild(div);
                });
            },
            
            toggleTheme() { game.data.toggleTheme(); this.updateSettingsUI(); },
            toggleSound() { game.data.toggleSound(); this.updateSettingsUI(); },
            showScreen(name) {
                this.screens.menu.classList.add('hidden');
                this.screens.game.classList.add('hidden');
                document.getElementById('pause-screen').classList.add('hidden');
                document.getElementById('gameover-screen').classList.add('hidden');
                if (name === 'menu') { this.screens.menu.classList.remove('hidden'); this.init(); } 
                else if (name === 'game') { this.screens.game.classList.remove('hidden'); }
            },
            showSettings() { document.getElementById('settings-modal').classList.remove('hidden'); },
            showRules() { document.getElementById('rules-modal').classList.remove('hidden'); },
            showStats() { this.updateStatsValues(); document.getElementById('stats-modal').classList.remove('hidden'); },
            hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        };

        const game = new Game(); 
        window.onload = async () => {
            await initVK();
            await game.data.load();
            ui.init();
            game.resize(); 
        };

    </script>
</body>
</html>