<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soft Drop 2048</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --bg-color: #FAF8EF;
            --text-color: #776e65;
            --header-bg: #bbada0;
            --score-bg: #cdc1b4;
            --score-text: #eee4da;
            --canvas-bg: #CDC1B4;
            --modal-bg: rgba(250, 248, 239, 0.95);
            --modal-shadow: rgba(0,0,0,0.15);
            --btn-bg: #faf8ef;
            --btn-text: #776e65;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --card-locked: #f3f4f6;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #e5e7eb;
            --header-bg: #374151;
            --score-bg: #4b5563;
            --score-text: #e5e7eb;
            --canvas-bg: #1f2937;
            --modal-bg: rgba(17, 24, 39, 0.95);
            --modal-shadow: rgba(0,0,0,0.5);
            --btn-bg: #374151;
            --btn-text: #e5e7eb;
            --card-bg: #1f2937;
            --card-border: #374151;
            --card-locked: #111827;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
            -webkit-user-select: none;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        #game-wrapper {
            position: relative;
            width: 340px; /* –§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏ */
            display: flex;
            flex-direction: column;
            filter: drop-shadow(0 10px 20px var(--modal-shadow));
            z-index: 1;
        }

        #game-header {
            background: var(--header-bg);
            border-radius: 12px 12px 0 0;
            height: 70px;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—ã—à–µ –∫–∞–Ω–≤–∞—Å–∞ */
            transition: background 0.3s;
            position: relative; 
        }

        .score-box {
            background: var(--score-bg);
            padding: 5px 15px;
            border-radius: 6px;
            color: var(--score-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            transition: background 0.3s;
        }

        canvas {
            display: block;
            border-radius: 0 0 12px 12px;
            background: var(--canvas-bg);
            transition: background 0.3s;
            z-index: 10;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--btn-text);
            background: var(--btn-bg);
            font-size: 1.2rem;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: visible;
            pointer-events: auto; /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å */
        }
        .control-btn:active { transform: scale(0.95); }
        
        .delete-active {
            background: #ff6b6b !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        
        .ad-badge {
            position: absolute;
            top: -6px; right: -6px;
            background-color: #3b82f6;
            color: white; font-size: 9px; font-weight: 900;
            padding: 2px 4px; border-radius: 4px;
            border: 2px solid var(--bg-color);
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .menu-modal {
            position: absolute; inset: 0; z-index: 50;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª */
        .tutorial-container {
            position: relative; width: 120px; height: 160px;
            background: rgba(0,0,0,0.05); border-radius: 12px;
            margin: 0 auto 10px; overflow: hidden;
        }
        .t-ball {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; color: #776e65;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }
        .t-ball.val-2 { background: #eee4da; }
        .t-hand {
            position: absolute; font-size: 24px; top: 10px; left: 50%;
            transform: translateX(-50%);
            animation: handMove 3s infinite;
            z-index: 10;
        }
        .t-drop {
            left: 50%; top: 40px; margin-left: -15px; opacity: 0;
            animation: ballDrop 3s infinite;
        }
        .t-static {
            left: 50%; bottom: 10px; margin-left: -15px;
            animation: ballMergeBottom 3s infinite;
        }
        .t-result {
            left: 50%; bottom: 10px; margin-left: -15px;
            background: #ede0c8; color: #776e65; opacity: 0;
            animation: showResult 3s infinite;
            z-index: 2;
        }

        @keyframes handMove { 0%, 10% { transform: translateX(-50%) scale(1); } 20% { transform: translateX(-50%) scale(0.9); } 30% { transform: translateX(-50%) scale(1); } 100% { transform: translateX(-50%) scale(1); } }
        @keyframes ballDrop { 0%, 20% { top: 40px; opacity: 0; } 25% { opacity: 1; } 45% { top: 110px; opacity: 1; } 50% { opacity: 0; } 100% { opacity: 0; } }
        @keyframes ballMergeBottom { 0%, 45% { transform: scale(1); background: #eee4da; opacity: 1; } 45.1% { content: "2"; } 50% { transform: scale(1.2); background: #ede0c8; } 60% { transform: scale(1); background: #ede0c8; } 85% { opacity: 1; } 90% { opacity: 0; } 100% { opacity: 0; } }
        @keyframes showResult { 0%, 49% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } 60% { transform: scale(1); } 85% { opacity: 1; } 90% { opacity: 0; } 100% { opacity: 0; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } }

        /* –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .stats-table th { text-align: left; padding: 8px; border-bottom: 2px solid var(--card-border); opacity: 0.6; font-size: 0.75rem; uppercase; }
        .stats-table td { padding: 8px; border-bottom: 1px solid var(--card-border); font-weight: bold; }
        .stats-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

    <!-- –û–±–µ—Ä—Ç–∫–∞ –∏–≥—Ä—ã -->
    <div id="game-wrapper" class="hidden">
        
        <!-- –®–∞–ø–∫–∞ -->
        <div id="game-header">
            <div class="score-box">
                <span class="text-[10px] font-bold uppercase tracking-wider opacity-70">–°—á–µ—Ç</span>
                <span id="score-display" class="text-xl font-bold leading-tight">0</span>
            </div>

            <div class="flex gap-3">
                <button id="btn-delete" onclick="game.sound.playClick(); game.tryActivateDelete()" class="control-btn" title="–£–¥–∞–ª–∏—Ç—å —à–∞—Ä">
                    <div class="ad-badge">AD</div>
                    <i class="fas fa-eraser"></i>
                </button>

                <button onclick="game.sound.playClick(); game.togglePause()" class="control-btn" title="–ü–∞—É–∑–∞">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
        </div>

        <canvas id="world"></canvas>
        
        <div id="danger-line" class="absolute w-full border-b-2 border-dashed border-red-400 opacity-0 transition-opacity duration-300 pointer-events-none z-20" style="top: 200px;">
            <span class="absolute right-2 -top-6 text-[10px] text-white font-bold bg-red-400 px-2 py-0.5 rounded-full shadow-sm">–û–ü–ê–°–ù–û–°–¢–¨</span>
        </div>

        <!-- –ü–∞—É–∑–∞ -->
        <div id="pause-screen" class="absolute inset-0 z-40 hidden flex flex-col items-center justify-center rounded-xl bounce-in" style="background: var(--modal-bg); backdrop-filter: blur(5px);">
            <h2 class="text-3xl font-black mb-6" style="color: var(--text-color);">–ü–∞—É–∑–∞</h2>
            <div class="w-48 space-y-3">
                <button onclick="game.sound.playClick(); game.togglePause()" class="w-full bg-[#edc22e] text-white py-3 rounded-lg font-bold shadow-md menu-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button onclick="game.sound.playClick(); game.quitToMenu()" class="w-full bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow-md menu-btn">–ú–µ–Ω—é</button>
            </div>
        </div>

        <!-- Game Over -->
        <div id="gameover-screen" class="absolute inset-0 z-40 hidden flex flex-col items-center justify-center rounded-xl bounce-in" style="background: var(--modal-bg); backdrop-filter: blur(5px);">
            <h2 class="text-4xl font-black mb-2" style="color: var(--text-color);">–§–∏–Ω–∏—Ç–∞!</h2>
            <p class="mb-6 text-sm font-semibold opacity-70" style="color: var(--text-color);">–ú–µ—Å—Ç–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç</p>
            
            <div class="rounded-lg px-8 py-4 mb-8 text-center shadow-inner" style="background: var(--score-bg); color: var(--score-text);">
                <div class="text-xs uppercase font-bold opacity-70">–í–∞—à —Å—á–µ—Ç</div>
                <div id="final-score" class="text-4xl font-black">0</div>
            </div>

            <div class="w-56 space-y-3">
                <button onclick="game.sound.playClick(); game.restart()" class="w-full bg-[#edc22e] text-white py-3 rounded-lg font-bold shadow-lg menu-btn hover:bg-[#e5ba2a]">
                    <i class="fas fa-redo mr-2"></i> –ó–∞–Ω–æ–≤–æ
                </button>
                <button onclick="game.sound.playClick(); game.quitToMenu()" class="w-full bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow-md menu-btn">
                    <i class="fas fa-home mr-2"></i> –ú–µ–Ω—é
                </button>
            </div>
        </div>
    </div>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="main-menu" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 transition-colors duration-300" style="background: var(--bg-color);">
        <div class="absolute top-4 right-4 z-50">
             <button onclick="game.sound.playClick(); ui.showSettings()" class="control-btn shadow-none bg-transparent hover:bg-black/5">
                <i class="fas fa-cog fa-lg"></i>
            </button>
        </div>

        <div class="text-center mb-6 slide-up">
            <div class="inline-block bg-[#edc22e] text-white text-5xl font-black p-4 rounded-xl shadow-lg mb-2">2048</div>
            <div class="text-3xl font-bold tracking-widest uppercase" style="color: var(--text-color);">Soft Drop</div>
        </div>
        
        <div class="w-full max-w-sm space-y-3 slide-up" style="animation-delay: 0.1s;">
            <button id="btn-continue" onclick="game.sound.playClick(); game.loadAndContinue()" class="hidden w-full bg-[#edc22e] text-white py-4 rounded-xl font-bold shadow-lg menu-btn mb-4 text-lg">
                <i class="fas fa-play mr-2"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>

            <div class="text-sm font-bold uppercase tracking-wide mb-2 ml-1 opacity-70" style="color: var(--text-color);">–ù–æ–≤–∞—è –∏–≥—Ä–∞</div>
            <div id="level-select" class="grid grid-cols-1 gap-3"></div>
            
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="game.sound.playClick(); ui.showRules()" class="bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow hover:bg-[#7f6a56] menu-btn text-sm">
                    –ö–∞–∫ –∏–≥—Ä–∞—Ç—å
                </button>
                <button onclick="game.sound.playClick(); ui.showStats()" class="bg-[#8f7a66] text-white py-3 rounded-lg font-bold shadow hover:bg-[#7f6a56] menu-btn text-sm">
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="settings-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-6" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" style="color: var(--text-color);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="game.sound.playClick(); ui.hideModal('settings-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--card-locked);">
                    <span class="font-bold" style="color: var(--text-color);">–¢–µ–º–∞</span>
                    <button id="theme-btn" onclick="game.sound.playClick(); ui.toggleTheme()" class="px-4 py-2 rounded-lg font-bold text-white transition-colors bg-[#8f7a66]">–°–≤–µ—Ç–ª–∞—è</button>
                </div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--card-locked);">
                    <span class="font-bold" style="color: var(--text-color);">–ó–≤—É–∫–∏</span>
                    <button id="sound-btn" onclick="game.sound.playClick(); ui.toggleSound()" class="px-4 py-2 rounded-lg font-bold text-white transition-colors bg-[#22c55e]">–í–ö–õ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
    <div id="rules-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-xs w-full shadow-2xl bounce-in p-5" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--card-border);">
                <h3 class="text-lg font-bold" style="color: var(--text-color);">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h3>
                <button onclick="game.sound.playClick(); ui.hideModal('rules-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times"></i></button>
            </div>
            <div class="tutorial-container">
                <div class="t-hand">üëÜ</div>
                <div class="t-ball t-drop val-2">2</div>
                <div class="t-ball t-static val-2">2</div>
                <div class="t-ball t-result val-4">4</div>
            </div>
            <div class="text-sm space-y-4" style="color: var(--text-color);">
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#bbada0] flex items-center justify-center text-white font-bold shrink-0 text-xs">1</div>
                    <p>–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–≥—É—Ä—É.</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#f65e3b] flex items-center justify-center text-white font-bold shrink-0 text-xs">2</div>
                    <p>–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —á–∏—Å–ª–∞ —Å–ª–∏–≤–∞—é—Ç—Å—è –≤ –Ω–æ–≤–æ–µ.</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-[#edc22e] flex items-center justify-center text-white font-bold shrink-0 text-xs"><i class="fas fa-eraser"></i></div>
                    <p>–õ–∞—Å—Ç–∏–∫ —É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω—é—é —Ñ–∏–≥—É—Ä—É.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats-modal" class="menu-modal hidden">
        <div class="rounded-2xl max-w-md w-full shadow-2xl bounce-in p-5" style="background: var(--card-bg);">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--card-border);">
                <h3 class="text-lg font-bold" style="color: var(--text-color);">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <button onclick="game.sound.playClick(); ui.hideModal('stats-modal')" class="opacity-50 hover:opacity-100" style="color: var(--text-color);"><i class="fas fa-times"></i></button>
            </div>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>–†–µ–∂–∏–º</th>
                        <th>–†–µ–∫–æ—Ä–¥</th>
                        <th>–ú–∞–∫—Å. –®–∞—Ä</th>
                    </tr>
                </thead>
                <tbody id="stats-table-body">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const CONFIG = {
            colors: {
                2: "#eee4da", 4: "#ede0c8", 8: "#f2b179", 16: "#f59563",
                32: "#f67c5f", 64: "#f65e3b", 128: "#edcf72", 256: "#edcc61",
                512: "#edc850", 1024: "#edc53f", 2048: "#edc22e", 4096: "#3c3a32"
            },
            textColors: { 2: "#776e65", 4: "#776e65", 8: "#f9f6f2" },
            // –í–ï–ó–î–ï –®–ò–†–ò–ù–ê 340
            levels: [
                { id: 'classic', name: '–ö–ª–∞—Å—Å–∏–∫–∞', scoreReq: 0, width: 340, desc: '–®–∞—Ä—ã', type: 'circle' },
                { id: 'squares', name: '–ö—É–±–∏–∑–º', scoreReq: 2000, width: 340, desc: '–ö–≤–∞–¥—Ä–∞—Ç—ã', type: 'square' },
                { id: 'chaos', name: '–•–∞–æ—Å', scoreReq: 5000, width: 340, desc: '–†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã', type: 'chaos' }
            ]
        };

        // --- VK ---
        let vkUserId = null;
        async function initVK() {
            try {
                if(window.vkBridge) {
                    await window.vkBridge.send('VKWebAppInit');
                    try {
                        const user = await window.vkBridge.send('VKWebAppGetUserInfo');
                        vkUserId = user.id;
                    } catch (e) {}
                    window.vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(()=>{});
                }
            } catch (e) {}
        }
        async function showRewardedAd() {
            if (!window.vkBridge) return true;
            try { return (await window.vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'reward' })).result; } catch { return false; }
        }
        function showInterstitialAd() {
            if (window.vkBridge) window.vkBridge.send('VKWebAppShowInterstitialAd').catch(()=>{});
        }

        // --- AUDIO ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = true;
            }
            playTone(freq, type, duration) {
                if (!this.enabled) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, t);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(t + duration);
            }
            playPop(value) { this.playTone(200 + (Math.log2(value) * 60), 'sine', 0.2); }
            playDelete() { this.playTone(150, 'square', 0.3); }
            playDrop() { this.playTone(80, 'triangle', 0.1); }
            playClick() { this.playTone(400, 'sine', 0.05); } 
            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
            toggle(state) { this.enabled = state; }
        }

        // --- DATA ---
        class DataManager {
            constructor() {
                this.data = {
                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –æ–±—ä–µ–∫—Ç –ø–æ —Ä–µ–∂–∏–º–∞–º
                    stats: {
                        classic: { highScore: 0, maxTile: 2 },
                        squares: { highScore: 0, maxTile: 2 },
                        chaos: { highScore: 0, maxTile: 2 }
                    },
                    unlockedLevels: ['classic', 'squares', 'chaos'], 
                    theme: 'light', sound: true, savedGame: null
                };
            }
            async load() {
                const local = localStorage.getItem('softdrop_save_v4');
                if (local) this.mergeData(JSON.parse(local));
                if (vkUserId && window.vkBridge) {
                    try {
                        const r = await window.vkBridge.send('VKWebAppStorageGet', { keys: [`save_v4_${vkUserId}`] });
                        if (r.keys[0]?.value) this.mergeData(JSON.parse(r.keys[0].value));
                    } catch (e) {}
                }
                this.applySettings();
            }
            mergeData(loaded) {
                // –ê–∫–∫—É—Ä–∞—Ç–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É stats –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
                if(loaded.stats) this.data.stats = { ...this.data.stats, ...loaded.stats };
                if(loaded.unlockedLevels) this.data.unlockedLevels = loaded.unlockedLevels;
                if(loaded.theme) this.data.theme = loaded.theme;
                if(loaded.sound !== undefined) this.data.sound = loaded.sound;
                if(loaded.savedGame) this.data.savedGame = loaded.savedGame;
            }
            async save() {
                const val = JSON.stringify(this.data);
                localStorage.setItem('softdrop_save_v4', val);
                if (vkUserId && window.vkBridge) {
                    window.vkBridge.send('VKWebAppStorageSet', { key: `save_v4_${vkUserId}`, value: val }).catch(()=>{});
                }
            }
            saveGame(gameState) { this.data.savedGame = gameState; this.save(); ui.updateContinueButton(); }
            clearSavedGame() { this.data.savedGame = null; this.save(); ui.updateContinueButton(); }
            
            updateScore(levelId, score, maxTile) {
                if (!this.data.stats[levelId]) this.data.stats[levelId] = { highScore: 0, maxTile: 2 };
                const s = this.data.stats[levelId];
                if (score > s.highScore) s.highScore = score;
                if (maxTile > s.maxTile) s.maxTile = maxTile;
                this.save();
            }
            
            toggleTheme() { this.data.theme = this.data.theme === 'light' ? 'dark' : 'light'; this.applySettings(); this.save(); return this.data.theme; }
            toggleSound() { this.data.sound = !this.data.sound; this.applySettings(); this.save(); return this.data.sound; }
            applySettings() {
                document.documentElement.setAttribute('data-theme', this.data.theme);
                game.sound.toggle(this.data.sound);
            }
        }

        // --- GAME ENGINE ---
        class Game {
            constructor() {
                this.engine = Matter.Engine.create({ enableSleeping: false });
                this.runner = Matter.Runner.create();
                this.renderCanvas = document.getElementById('world');
                this.ctx = this.renderCanvas.getContext('2d');
                this.width = 340; this.height = window.innerHeight * 0.75;
                this.score = 0;
                this.isPlaying = false;
                this.currentLevelId = 'classic';
                this.sound = new SoundManager();
                this.data = new DataManager();
                window.addEventListener('resize', () => { if(this.isPlaying) this.resize(); });
                this.setupInput();
                this.setupPhysicsEvents();
            }

            resize() {
                this.height = Math.min(window.innerHeight * 0.75, 800);
                this.renderCanvas.width = this.width;
                this.renderCanvas.height = this.height;
                // –ù–µ –º–µ–Ω—è–µ–º —à–∏—Ä–∏–Ω—É wrapper –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –æ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ CSS –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                
                if (this.ground) Matter.Body.setPosition(this.ground, { x: this.width/2, y: this.height + 50 });
                const dangerLine = document.getElementById('danger-line');
                if (dangerLine) dangerLine.style.top = `${this.height * 0.25}px`; 
            }

            createBody(x, y, value, isStatic = false) {
                const levelType = CONFIG.levels.find(l => l.id === this.currentLevelId).type;
                let body;
                // –†–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
                const baseSize = 22 + (Math.log2(value) * 2.5);
                
                let shape = 'circle';
                if (levelType === 'square') shape = 'rectangle';
                else if (levelType === 'chaos') {
                    // 2: –ö—Ä—É–≥, 4: –ö–≤–∞–¥—Ä–∞—Ç, 8: –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫, 16+: –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫
                    if (value === 2) shape = 'circle';
                    else if (value === 4) shape = 'rectangle';
                    else if (value === 8) shape = 'triangle';
                    else shape = 'hexagon';
                }

                const opts = {
                    restitution: 0.2,
                    friction: 0.5,
                    frictionStatic: 0.5, // –ß—Ç–æ–±—ã –Ω–µ —Å–∫–æ–ª—å–∑–∏–ª–∏ —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ
                    label: `body-${value}`,
                    isStatic: isStatic
                };

                // –í–ê–ñ–ù–û: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏, —á—Ç–æ–±—ã —Ñ–∏–≥—É—Ä—ã –Ω–µ "–¥—ã—à–∞–ª–∏"
                // –î–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∞ –∏ –∫—Ä—É–≥–∞ —Ä–∞–∑–º–µ—Ä—ã —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã
                if (shape === 'rectangle') {
                    // –ö–≤–∞–¥—Ä–∞—Ç. –®–∏—Ä–∏–Ω–∞ = baseSize * 1.8
                    const w = baseSize * 1.8;
                    // chamfer: { radius: 0 } —É–±–∏—Ä–∞–µ—Ç —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∑–∞–∑–æ—Ä–æ–≤
                    body = Matter.Bodies.rectangle(x, y, w, w, { ...opts, chamfer: { radius: 2 } });
                    body.gameSize = w / 2; // –†–∞–¥–∏—É—Å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã)
                } else if (shape === 'triangle') {
                    // –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (3 —Å—Ç–æ—Ä–æ–Ω—ã)
                    body = Matter.Bodies.polygon(x, y, 3, baseSize * 1.2, opts);
                    body.gameSize = baseSize * 1.2;
                } else if (shape === 'hexagon') {
                    // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫ (6 —Å—Ç–æ—Ä–æ–Ω)
                    body = Matter.Bodies.polygon(x, y, 6, baseSize, opts);
                    body.gameSize = baseSize;
                } else {
                    // –ö—Ä—É–≥
                    body = Matter.Bodies.circle(x, y, baseSize, opts);
                    body.gameSize = baseSize;
                }

                body.gameShape = shape;
                body.gameValue = value;
                return body;
            }

            start(levelId, loadFromSave = false) {
                this.currentLevelId = levelId;
                // –®–∏—Ä–∏–Ω–∞ –≤—Å–µ–≥–¥–∞ 340
                this.width = 340;
                this.resize();

                Matter.World.clear(this.engine.world);
                Matter.Engine.clear(this.engine);
                
                this.score = 0;
                this.isPlaying = true;
                this.isPaused = false;
                this.deleteMode = false;
                
                this.leftWall = Matter.Bodies.rectangle(-50, this.height/2, 100, this.height * 3, { isStatic: true, friction: 0 });
                this.rightWall = Matter.Bodies.rectangle(this.width + 50, this.height/2, 100, this.height * 3, { isStatic: true, friction: 0 });
                this.ground = Matter.Bodies.rectangle(this.width/2, this.height + 50, this.width + 200, 100, { isStatic: true, friction: 0.5 });
                Matter.World.add(this.engine.world, [this.ground, this.leftWall, this.rightWall]);

                if (loadFromSave && this.data.data.savedGame) {
                    this.restoreGame(this.data.data.savedGame);
                } else {
                    this.spawnNextPreview();
                }

                this.updateUI();
                Matter.Runner.run(this.runner, this.engine);
                this.sound.resume();
                this.loop();
                ui.showScreen('game');
            }

            restoreGame(saveData) {
                this.score = saveData.score;
                this.currentLevelId = saveData.levelId;
                this.nextValue = saveData.nextValue;
                saveData.bodies.forEach(b => {
                    const body = this.createBody(b.x, b.y, b.value);
                    Matter.Body.setAngle(body, b.angle);
                    Matter.World.add(this.engine.world, body);
                });
                this.spawnNextPreview(this.nextValue);
            }

            saveState() {
                if (!this.isPlaying) return;
                const bodies = Matter.Composite.allBodies(this.engine.world)
                    .filter(b => !b.isStatic && b.gameValue)
                    .map(b => ({ x: b.position.x, y: b.position.y, angle: b.angle, value: b.gameValue }));
                this.data.saveGame({ levelId: this.currentLevelId, score: this.score, nextValue: this.nextValue, bodies: bodies });
            }
            
            loadAndContinue() { if (this.data.data.savedGame) this.start(this.data.data.savedGame.levelId, true); }

            spawnNextPreview(forceValue = null) {
                if (forceValue) this.nextValue = forceValue;
                else {
                    const r = Math.random();
                    if (r < 0.6) this.nextValue = 2; else if (r < 0.85) this.nextValue = 4;
                    else if (r < 0.95) this.nextValue = 8; else this.nextValue = 16;
                }
                this.currentBall = { x: this.width / 2, y: 60, value: this.nextValue };
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ç–µ–ª–æ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                const temp = this.createBody(0,0,this.nextValue);
                this.currentBall.shape = temp.gameShape;
                this.currentBall.size = temp.gameSize;
            }

            dropBall() {
                if (!this.currentBall || this.isPaused || !this.isPlaying || this.deleteMode) return;
                const body = this.createBody(this.currentBall.x, this.currentBall.y, this.currentBall.value);
                Matter.World.add(this.engine.world, body);
                this.sound.playDrop();
                this.currentBall = null;
                setTimeout(() => this.saveState(), 100);
                setTimeout(() => { if (this.isPlaying) this.spawnNextPreview(); }, 400);
            }

            setupPhysicsEvents() {
                Matter.Events.on(this.engine, 'collisionStart', (event) => {
                    event.pairs.forEach((pair) => {
                        const A = pair.bodyA; const B = pair.bodyB;
                        if (A.isStatic || B.isStatic) return;
                        if (A.gameValue === B.gameValue && !A.toRemove && !B.toRemove) {
                            A.toRemove = true; B.toRemove = true;
                            this.mergeBodies(A, B);
                        }
                    });
                });
                setInterval(() => { if(this.isPlaying && !this.isPaused) this.checkGameOver(); }, 1000);
            }

            mergeBodies(A, B) {
                const newValue = A.gameValue * 2;
                const midX = (A.position.x + B.position.x) / 2;
                const midY = (A.position.y + B.position.y) / 2;
                Matter.World.remove(this.engine.world, [A, B]);
                const newBody = this.createBody(midX, midY, newValue);
                Matter.World.add(this.engine.world, newBody);
                this.score += newValue;
                this.sound.playPop(newValue);
                this.updateUI();
                this.saveState();
            }

            checkGameOver() {
                const dangerY = this.height * 0.25; 
                let dangerCount = 0;
                const bodies = Matter.Composite.allBodies(this.engine.world);
                bodies.forEach(b => { 
                    if (!b.isStatic && b.position.y < dangerY && Math.abs(b.velocity.y) < 0.1 && Math.abs(b.velocity.x) < 0.1) dangerCount++; 
                });
                const line = document.getElementById('danger-line');
                if(line) line.style.opacity = dangerCount > 0 ? '1' : '0';
                const topTouch = bodies.some(b => !b.isStatic && b.position.y < 30);
                if (dangerCount > 1 || topTouch) {
                    setTimeout(() => { if(this.isPlaying && (document.getElementById('danger-line')?.style.opacity === '1' || topTouch)) this.gameOver(); }, 1500);
                }
            }

            setupInput() {
                const getPos = (e) => {
                    const rect = this.renderCanvas.getBoundingClientRect();
                    let t = (e.touches && e.touches.length > 0) ? e.touches[0] : (e.changedTouches && e.changedTouches.length > 0 ? e.changedTouches[0] : e);
                    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
                };
                const handleMove = (pos) => {
                    if (this.deleteMode || !this.currentBall || this.isPaused) return;
                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è —Å–ø–∞–≤–Ω–µ—Ä–∞
                    const r = this.currentBall.size; 
                    this.currentBall.x = Math.max(r, Math.min(this.width - r, pos.x));
                };
                const handleClick = (e) => {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –ø–æ –∫–Ω–æ–ø–∫–∞–º —Ö–µ–¥–µ—Ä–∞ (–æ–Ω–∏ –≤—ã—à–µ –∫–∞–Ω–≤–∞—Å–∞), –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º
                    // –ù–æ —Ö–µ–¥–µ—Ä –Ω–µ –Ω–∞–¥ –∫–∞–Ω–≤–∞—Å–æ–º, –∞ —Ä—è–¥–æ–º. 
                    e.preventDefault();
                    if (this.deleteMode) this.tryDeleteAt(getPos(e)); else this.dropBall();
                };
                this.renderCanvas.addEventListener('mousemove', e => handleMove(getPos(e)));
                this.renderCanvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(getPos(e)); }, { passive: false });
                this.renderCanvas.addEventListener('mousedown', handleClick);
                this.renderCanvas.addEventListener('touchend', handleClick);
            }

            async tryActivateDelete() {
                if (this.deleteMode) { this.toggleDeleteMode(); return; }
                const success = await showRewardedAd();
                if (success) this.toggleDeleteMode();
            }

            toggleDeleteMode() {
                this.deleteMode = !this.deleteMode;
                const btn = document.getElementById('btn-delete');
                const canvas = document.getElementById('world');
                if (this.deleteMode) { btn.classList.add('delete-active'); canvas.classList.add('cursor-delete'); }
                else { btn.classList.remove('delete-active'); canvas.classList.remove('cursor-delete'); }
            }

            tryDeleteAt(pos) {
                const bodies = Matter.Composite.allBodies(this.engine.world);
                const clickedBody = bodies.find(b => {
                    if (b.isStatic) return false;
                    return Matter.Bounds.contains(b.bounds, pos);
                });
                if (clickedBody) {
                    Matter.World.remove(this.engine.world, clickedBody);
                    this.sound.playDelete();
                    this.toggleDeleteMode();
                    this.saveState();
                }
            }

            loop() {
                if (!this.isPlaying) return;
                requestAnimationFrame(() => this.loop());
                
                const canvasColor = getComputedStyle(document.body).getPropertyValue('--canvas-bg').trim();
                this.ctx.fillStyle = canvasColor || "#CDC1B4";
                this.ctx.fillRect(0, 0, this.width, this.height);

                const bodies = Matter.Composite.allBodies(this.engine.world);
                bodies.forEach(body => {
                    if (body.isStatic) return;
                    this.ctx.save();
                    this.ctx.translate(body.position.x, body.position.y);
                    this.ctx.rotate(body.angle);
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º gameSize –≤–º–µ—Å—Ç–æ bounds, —á—Ç–æ–±—ã –Ω–µ "–¥—ã—à–∞–ª–æ"
                    this.drawBody(body.gameShape, body.gameSize, body.gameValue);
                    this.ctx.restore();
                });

                if (this.currentBall && !this.deleteMode && !this.isPaused) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.currentBall.x, this.currentBall.y);
                    this.ctx.lineTo(this.currentBall.x, this.height);
                    this.ctx.strokeStyle = "rgba(120,120,120,0.3)";
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([6, 6]);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    this.drawBody(this.currentBall.shape, this.currentBall.size, this.currentBall.value, this.currentBall.x, this.currentBall.y);
                }
                
                if (this.deleteMode) {
                    this.ctx.fillStyle = "rgba(0,0,0,0.5)";
                    this.ctx.fillRect(0, 0, this.width, this.height);
                    this.ctx.fillStyle = "#fff";
                    this.ctx.font = "bold 18px Nunito";
                    this.ctx.textAlign = "center";
                    this.ctx.fillText("–ù–∞–∂–º–∏ –Ω–∞ —Ñ–∏–≥—É—Ä—É", this.width/2, 120);
                }
            }

            drawBody(shape, size, value, x=0, y=0) {
                const color = CONFIG.colors[value] || "#3c3a32";
                this.ctx.fillStyle = color;
                this.ctx.beginPath();
                
                if (shape === 'rectangle') {
                    // size - —ç—Ç–æ –ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã (gameSize)
                    const w = size * 2;
                    this.ctx.roundRect(x - size, y - size, w, w, 2);
                } else if (shape === 'triangle') {
                    // –†–∏—Å—É–µ–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫
                    const h = size * Math.sqrt(3) / 2;
                    this.ctx.moveTo(x, y - size);
                    this.ctx.lineTo(x + size * Math.sin(2 * Math.PI / 3), y - size * Math.cos(2 * Math.PI / 3));
                    this.ctx.lineTo(x + size * Math.sin(4 * Math.PI / 3), y - size * Math.cos(4 * Math.PI / 3));
                    this.ctx.closePath();
                } else if (shape === 'hexagon') {
                     // –†–∏—Å—É–µ–º —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫
                    for (let i = 0; i < 6; i++) {
                        const angle = i * 2 * Math.PI / 6;
                        const px = x + size * Math.cos(angle);
                        const py = y + size * Math.sin(angle);
                        if (i === 0) this.ctx.moveTo(px, py); else this.ctx.lineTo(px, py);
                    }
                    this.ctx.closePath();
                } else {
                    this.ctx.arc(x, y, size, 0, Math.PI * 2);
                }
                
                this.ctx.fill();

                // –ë–ª–∏–∫
                const grad = this.ctx.createRadialGradient(x - size/3, y - size/3, size/6, x, y, size);
                grad.addColorStop(0, "rgba(255,255,255,0.4)");
                grad.addColorStop(1, "rgba(0,0,0,0)");
                this.ctx.fillStyle = grad;
                this.ctx.fill();

                this.ctx.fillStyle = CONFIG.textColors[value] || "#f9f6f2";
                this.ctx.font = `900 ${Math.max(10, size * 0.7)}px Nunito`;
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                this.ctx.fillText(value, x, y + 1);
            }

            gameOver() {
                this.isPlaying = false;
                Matter.Runner.stop(this.runner);
                showInterstitialAd();
                
                let max = 0;
                Matter.Composite.allBodies(this.engine.world).forEach(b => { if(b.gameValue > max) max = b.gameValue; });
                
                this.data.updateScore(this.currentLevelId, this.score, max);
                this.data.clearSavedGame(); // –û—á–∏—â–∞–µ–º —Å–µ–π–≤ –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ

                document.getElementById('final-score').innerText = this.score;
                document.getElementById('gameover-screen').classList.remove('hidden');
            }

            restart() {
                document.getElementById('gameover-screen').classList.add('hidden');
                document.getElementById('danger-line').style.opacity = 0;
                this.start(this.currentLevelId);
            }

            quitToMenu() {
                this.saveState();
                this.isPlaying = false;
                Matter.Runner.stop(this.runner);
                ui.showScreen('menu');
            }

            updateUI() { document.getElementById('score-display').innerText = this.score; }
        }

        const ui = {
            screens: { menu: document.getElementById('main-menu'), game: document.getElementById('game-wrapper') },
            
            init() {
                this.renderLevelSelect();
                this.updateContinueButton();
            },

            updateContinueButton() {
                const btn = document.getElementById('btn-continue');
                if (game.data.data.savedGame) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            },

            updateStatsTable() {
                const tbody = document.getElementById('stats-table-body');
                tbody.innerHTML = '';
                const stats = game.data.data.stats;
                
                CONFIG.levels.forEach(lvl => {
                    const row = document.createElement('tr');
                    const lvlStats = stats[lvl.id] || { highScore: 0, maxTile: 0 };
                    
                    row.innerHTML = `
                        <td>
                            <div class="text-xs uppercase opacity-60">${lvl.name}</div>
                        </td>
                        <td class="text-[#edc22e] text-lg">${lvlStats.highScore}</td>
                        <td class="text-[#f67c5f]">${lvlStats.maxTile > 2 ? lvlStats.maxTile : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            },

            updateSettingsUI() {
                const d = game.data.data;
                const themeBtn = document.getElementById('theme-btn');
                const soundBtn = document.getElementById('sound-btn');
                
                themeBtn.innerText = d.theme === 'light' ? '–°–≤–µ—Ç–ª–∞—è' : '–¢–µ–º–Ω–∞—è';
                themeBtn.className = `px-4 py-2 rounded-lg font-bold text-white transition-colors ${d.theme === 'light' ? 'bg-[#8f7a66]' : 'bg-gray-600'}`;
                
                soundBtn.innerText = d.sound ? '–í–ö–õ' : '–í–´–ö–õ';
                soundBtn.className = `px-4 py-2 rounded-lg font-bold text-white transition-colors ${d.sound ? 'bg-[#22c55e]' : 'bg-red-500'}`;
            },

            renderLevelSelect() {
                const container = document.getElementById('level-select');
                container.innerHTML = '';
                CONFIG.levels.forEach(lvl => {
                    const isUnlocked = game.data.data.unlockedLevels.includes(lvl.id);
                    const div = document.createElement('div');
                    let classes = "p-4 rounded-xl flex justify-between items-center cursor-pointer transition-all relative overflow-hidden ";
                    classes += isUnlocked 
                        ? "shadow hover:shadow-md border-l-4 border-[#edc22e]" 
                        : "opacity-60 border-l-4 border-gray-300 locked";
                    div.style.background = isUnlocked ? "var(--card-bg)" : "var(--card-locked)";
                    div.style.color = "var(--text-color)";
                    
                    div.className = classes;
                    div.onclick = () => { if(isUnlocked) { game.sound.playClick(); game.start(lvl.id); } };
                    div.innerHTML = `
                        <div>
                            <div class="font-bold">${lvl.name}</div>
                            <div class="text-xs opacity-70">${lvl.desc}</div>
                        </div>
                        ${isUnlocked ? '<i class="fas fa-play text-[#edc22e]"></i>' : `<span class="text-[10px] font-bold text-white bg-gray-400 px-2 py-1 rounded">–°—á–µ—Ç: ${lvl.scoreReq}</span>`}
                    `;
                    container.appendChild(div);
                });
            },
            
            toggleTheme() { game.data.toggleTheme(); this.updateSettingsUI(); },
            toggleSound() { game.data.toggleSound(); this.updateSettingsUI(); },
            showScreen(name) {
                this.screens.menu.classList.add('hidden');
                this.screens.game.classList.add('hidden');
                document.getElementById('pause-screen').classList.add('hidden');
                document.getElementById('gameover-screen').classList.add('hidden');
                if (name === 'menu') { this.screens.menu.classList.remove('hidden'); this.init(); } 
                else if (name === 'game') { this.screens.game.classList.remove('hidden'); }
            },
            showSettings() { document.getElementById('settings-modal').classList.remove('hidden'); this.updateSettingsUI(); },
            showRules() { document.getElementById('rules-modal').classList.remove('hidden'); },
            showStats() { this.updateStatsTable(); document.getElementById('stats-modal').classList.remove('hidden'); },
            hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        };

        const game = new Game(); 
        window.onload = async () => {
            await initVK();
            await game.data.load();
            ui.init();
            game.resize(); 
        };

    </script>
</body>
</html>